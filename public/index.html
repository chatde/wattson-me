<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
<meta name="theme-color" content="#050510">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Free AI powered by the devices you forgot about. Ask anything.">
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='11' cy='14' r='4' fill='%230A84FF'/><circle cx='21' cy='14' r='4' fill='%230A84FF'/></svg>">
<title>Wattson — AI For the World</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────────────────────── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
  color:#F5F5F7;
  background:#050510;
  background-image:
    radial-gradient(ellipse at 15% 50%,rgba(30,15,70,0.35) 0%,transparent 50%),
    radial-gradient(ellipse at 85% 15%,rgba(10,30,90,0.25) 0%,transparent 40%),
    radial-gradient(ellipse at 50% 85%,rgba(25,10,55,0.2) 0%,transparent 45%);
  background-attachment:fixed;
  min-height:100vh;
  min-height:100dvh;
  overflow-x:hidden;
  line-height:1.5;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
a{color:#0A84FF;text-decoration:none}
a:hover{color:#409CFF}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;-webkit-tap-highlight-color:transparent}

/* ── Stars Canvas ─────────────────────────────────────────────────────────── */
#stars-canvas{
  position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:0;
}

/* ── Navigation ───────────────────────────────────────────────────────────── */
#nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  height:56px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  background:rgba(5,5,16,0.7);
  -webkit-backdrop-filter:blur(20px) saturate(1.8);
  backdrop-filter:blur(20px) saturate(1.8);
  border-bottom:1px solid rgba(255,255,255,0.06);
  transition:background 0.3s ease;
}
#nav.scrolled{background:rgba(5,5,16,0.92)}
.nav-logo{
  font-size:20px;font-weight:700;letter-spacing:-0.02em;
  color:#F5F5F7;cursor:pointer;
  display:flex;align-items:center;gap:10px;
  user-select:none;
}
.nav-logo .logo-eyes{
  display:flex;gap:4px;
}
.nav-logo .logo-eye{
  width:10px;height:10px;border-radius:50%;
  background:radial-gradient(circle at 40% 40%,#5dade2 0%,#1a5276 100%);
  box-shadow:0 0 6px rgba(52,152,219,0.5);
}
.nav-tabs{display:flex;gap:2px;list-style:none;overflow:hidden}
.nav-tab{
  padding:8px 12px;border-radius:20px;
  font-size:13px;font-weight:500;white-space:nowrap;
  color:rgba(245,245,247,0.6);
  transition:all 0.2s ease;
  cursor:pointer;
  min-height:36px;display:flex;align-items:center;
}
@media(hover:hover){.nav-tab:hover{color:#F5F5F7;background:rgba(255,255,255,0.06)}}
.nav-tab.active{color:#F5F5F7;background:rgba(10,132,255,0.15)}
.nav-hamburger{
  display:none;width:44px;height:44px;
  align-items:center;justify-content:center;
  border-radius:8px;
  background:none;border:none;padding:0;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
  position:relative;z-index:101;
}
@media(hover:hover){.nav-hamburger:hover{background:rgba(255,255,255,0.06)}}
.hamburger-icon{
  width:20px;height:14px;position:relative;
  display:flex;flex-direction:column;justify-content:space-between;
}
.hamburger-icon span{
  display:block;height:2px;background:#F5F5F7;border-radius:1px;
  transition:all 0.3s ease;
}
.nav-hamburger.open .hamburger-icon span:nth-child(1){transform:translateY(6px) rotate(45deg)}
.nav-hamburger.open .hamburger-icon span:nth-child(2){opacity:0}
.nav-hamburger.open .hamburger-icon span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}
.mobile-menu{
  display:none;position:fixed;
  top:56px;left:0;right:0;
  background:rgba(5,5,16,0.95);
  -webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,255,255,0.06);
  padding:8px 16px 16px;z-index:99;
  transform:translateY(-100%);opacity:0;
  transition:transform 0.3s ease,opacity 0.3s ease;
}
.mobile-menu.open{transform:translateY(0);opacity:1}
.mobile-menu-item{
  display:block;padding:14px 16px;
  font-size:17px;font-weight:500;
  color:rgba(245,245,247,0.7);border-radius:12px;
  transition:all 0.2s ease;cursor:pointer;
}
.mobile-menu-item.active{color:#F5F5F7;background:rgba(255,255,255,0.06)}
@media(hover:hover){.mobile-menu-item:hover{color:#F5F5F7;background:rgba(255,255,255,0.06)}}

/* ── Page Container ───────────────────────────────────────────────────────── */
main{position:relative;z-index:1;min-height:100vh;min-height:100dvh}
.page{
  display:none!important;opacity:0;
  transition:opacity 0.3s ease;
  padding-top:56px;
  padding-bottom:env(safe-area-inset-bottom,0);
}
.page.active{display:block!important}
.page.visible{opacity:1}

/* ── HOME PAGE ────────────────────────────────────────────────────────────── */
#page-home.active{
  display:flex!important;flex-direction:column;align-items:center;
  justify-content:center;
  min-height:100vh;min-height:100dvh;
  padding:56px 24px env(safe-area-inset-bottom,24px);
  transition:opacity 0.3s ease;
}
#page-home.has-results{justify-content:flex-start;padding-top:120px}
.home-logo{
  font-size:clamp(3rem,8vw,5rem);font-weight:700;
  letter-spacing:-0.03em;
  background:linear-gradient(135deg,#F5F5F7 0%,rgba(245,245,247,0.7) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:8px;
  user-select:none;
  transition:all 0.5s ease;
}
#page-home.has-results .home-logo{font-size:clamp(1.5rem,4vw,2rem);margin-bottom:16px}
.home-tagline{
  font-size:clamp(0.9rem,2.5vw,1.1rem);
  color:rgba(245,245,247,0.45);
  margin-bottom:40px;
  text-align:center;
  transition:all 0.5s ease;
}
#page-home.has-results .home-tagline{display:none}

/* Search Bar */
.search-container{
  width:100%;max-width:640px;
  position:relative;
  margin-bottom:24px;
  transition:all 0.3s ease;
}
.search-bar{
  width:100%;
  padding:16px 56px 16px 24px;
  font-size:17px;font-family:inherit;
  color:#F5F5F7;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:50px;
  outline:none;
  transition:all 0.3s ease;
}
.search-bar::placeholder{color:rgba(245,245,247,0.3)}
.search-bar:focus{
  background:rgba(255,255,255,0.09);
  border-color:rgba(10,132,255,0.4);
  box-shadow:0 0 0 3px rgba(10,132,255,0.1),0 8px 32px rgba(0,0,0,0.3);
}
.search-actions{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);
  display:flex;gap:4px;align-items:center;
}
.search-btn{
  width:44px;height:44px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s ease;
  color:rgba(245,245,247,0.5);
  -webkit-tap-highlight-color:transparent;
}
@media(hover:hover){.search-btn:hover{background:rgba(255,255,255,0.08);color:#F5F5F7}}
.search-btn.primary{background:#0A84FF;color:#fff}
@media(hover:hover){.search-btn.primary:hover{background:#409CFF}}
.search-btn.primary:disabled{background:rgba(10,132,255,0.3);cursor:not-allowed}
.search-btn svg{width:20px;height:20px}
#voice-btn.listening{background:rgba(255,59,48,0.2);color:#FF453A;animation:pulse-listen 1.5s ease infinite}
@keyframes pulse-listen{0%,100%{box-shadow:0 0 0 0 rgba(255,59,48,0.3)}50%{box-shadow:0 0 0 10px rgba(255,59,48,0)}}
.device-count{
  font-size:13px;color:rgba(245,245,247,0.3);
  text-align:center;
  transition:all 0.5s ease;
}
#page-home.has-results .device-count{display:none}

/* Search Results */
.results-area{
  width:100%;max-width:640px;
  margin-top:16px;
}
.result-card{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;
  padding:24px;
  margin-bottom:16px;
  animation:fadeSlideUp 0.4s ease;
}
.result-query{
  font-size:13px;color:rgba(245,245,247,0.35);
  margin-bottom:12px;
  display:flex;align-items:center;gap:8px;
}
.result-query::before{
  content:'';display:block;width:6px;height:6px;
  border-radius:50%;background:#0A84FF;flex-shrink:0;
}
.result-text{
  font-size:16px;line-height:1.65;
  color:rgba(245,245,247,0.85);
}
.result-text .cursor{
  display:inline-block;width:2px;height:1.1em;
  background:#0A84FF;vertical-align:text-bottom;
  animation:blink-cursor 0.8s step-end infinite;
}
@keyframes blink-cursor{0%,100%{opacity:1}50%{opacity:0}}
.loading-shimmer{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;
  padding:24px;
  animation:fadeSlideUp 0.4s ease;
}
.shimmer-line{
  height:14px;border-radius:7px;
  background:linear-gradient(90deg,rgba(255,255,255,0.04) 0%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 100%);
  background-size:200% 100%;
  animation:shimmer 1.5s ease infinite;
  margin-bottom:12px;
}
.shimmer-line:nth-child(1){width:90%}
.shimmer-line:nth-child(2){width:75%}
.shimmer-line:nth-child(3){width:60%}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* ── ABOUT PAGE ───────────────────────────────────────────────────────────── */
.about-content{max-width:720px;margin:0 auto;padding:80px 24px 64px}
.about-hero{text-align:center;margin-bottom:80px}
.about-hero h1{
  font-size:clamp(2rem,5vw,3rem);font-weight:700;
  letter-spacing:-0.02em;margin-bottom:16px;
  background:linear-gradient(135deg,#F5F5F7 0%,rgba(245,245,247,0.6) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.about-hero p{
  font-size:clamp(1rem,2.5vw,1.2rem);
  color:rgba(245,245,247,0.5);
  max-width:520px;margin:0 auto;line-height:1.7;
}
.about-section{margin-bottom:64px}
.about-section h2{
  font-size:clamp(1.3rem,3vw,1.8rem);font-weight:600;
  letter-spacing:-0.01em;margin-bottom:24px;
}
.about-section p,.about-section li{
  font-size:16px;line-height:1.75;
  color:rgba(245,245,247,0.65);margin-bottom:16px;
}
.about-section ul{list-style:none;padding:0}
.about-section li{padding-left:24px;position:relative}
.about-section li::before{
  content:'';position:absolute;left:0;top:10px;
  width:8px;height:8px;border-radius:50%;
  background:#0A84FF;opacity:0.6;
}
.about-diagram{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;padding:32px;
  margin:32px 0;text-align:center;
}
.diagram-flow{
  display:flex;align-items:center;justify-content:center;
  flex-wrap:wrap;gap:16px;
  font-size:14px;color:rgba(245,245,247,0.6);
}
.diagram-node{
  background:rgba(10,132,255,0.1);
  border:1px solid rgba(10,132,255,0.2);
  border-radius:12px;padding:12px 20px;
  font-weight:500;color:rgba(245,245,247,0.8);
}
.diagram-arrow{color:rgba(10,132,255,0.4);font-size:20px}
.about-footer{
  text-align:center;padding-top:48px;
  border-top:1px solid rgba(255,255,255,0.06);
  color:rgba(245,245,247,0.3);font-size:14px;
}
.about-footer a{color:#0A84FF}

/* ── START PAGE ───────────────────────────────────────────────────────────── */
.start-content{max-width:800px;margin:0 auto;padding:80px 24px 64px}
.start-hero{text-align:center;margin-bottom:64px}
.start-hero h1{
  font-size:clamp(2rem,5vw,2.8rem);font-weight:700;
  letter-spacing:-0.02em;margin-bottom:16px;
}
.start-hero p{font-size:17px;color:rgba(245,245,247,0.5);max-width:480px;margin:0 auto}
.power-modes{display:flex;gap:16px;margin-bottom:64px;flex-wrap:wrap}
.power-card{
  flex:1;min-width:220px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;padding:28px 24px;
  transition:all 0.3s ease;
}
@media(hover:hover){.power-card:hover{
  background:rgba(255,255,255,0.05);
  border-color:rgba(255,255,255,0.12);
  transform:translateY(-2px);
}}
.power-icon{
  font-size:28px;margin-bottom:16px;
  width:48px;height:48px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
}
.power-card.full .power-icon{background:rgba(48,209,88,0.15);color:#30D158}
.power-card.half .power-icon{background:rgba(255,214,10,0.15);color:#FFD60A}
.power-card.eco .power-icon{background:rgba(10,132,255,0.15);color:#0A84FF}
.power-card h3{font-size:18px;font-weight:600;margin-bottom:8px}
.power-card p{font-size:14px;color:rgba(245,245,247,0.5);line-height:1.6}
.power-card .power-best{
  margin-top:12px;padding-top:12px;
  border-top:1px solid rgba(255,255,255,0.06);
  font-size:13px;color:rgba(245,245,247,0.35);
}
.section-title{
  font-size:clamp(1.3rem,3vw,1.8rem);font-weight:600;
  margin-bottom:24px;letter-spacing:-0.01em;
}
.device-grid{
  display:flex;flex-wrap:wrap;gap:12px;margin-bottom:48px;
}
.device-tag{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:50px;padding:8px 20px;
  font-size:14px;color:rgba(245,245,247,0.65);
}
.setup-guides{margin-bottom:48px}
.setup-item{
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:8px;
  overflow:hidden;
}
.setup-header{
  padding:16px 20px;
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;font-weight:500;font-size:16px;
  color:rgba(245,245,247,0.8);
  transition:background 0.2s ease;
  min-height:52px;
}
.setup-header:hover{background:rgba(255,255,255,0.03)}
.setup-chevron{
  transition:transform 0.3s ease;
  color:rgba(245,245,247,0.3);font-size:14px;
}
.setup-item.open .setup-chevron{transform:rotate(180deg)}
.setup-body{
  max-height:0;overflow:hidden;
  transition:max-height 0.3s ease;
}
.setup-body-inner{
  padding:0 20px 20px;
  font-size:14px;color:rgba(245,245,247,0.55);line-height:1.8;
}
.setup-body-inner code{
  background:rgba(255,255,255,0.06);
  padding:2px 8px;border-radius:6px;
  font-family:'SF Mono','Fira Code',monospace;
  font-size:13px;color:rgba(245,245,247,0.75);
}
.setup-body-inner pre{
  background:rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:8px;padding:16px;
  margin:12px 0;overflow-x:auto;
  font-family:'SF Mono','Fira Code',monospace;
  font-size:13px;line-height:1.6;
  color:rgba(245,245,247,0.75);
}
/* Contribute Wizard */
.contribute-wizard{
  max-width:640px;margin:0 auto 48px;
}
.wizard-progress{
  display:flex;align-items:center;justify-content:center;
  gap:0;margin-bottom:32px;
}
.wizard-progress-step{
  display:flex;align-items:center;gap:8px;
  font-size:13px;font-weight:600;
  color:rgba(245,245,247,0.25);
  transition:color 0.3s ease;
  white-space:nowrap;
}
.wizard-progress-step span{
  display:inline-flex;align-items:center;justify-content:center;
  width:28px;height:28px;border-radius:50%;
  background:rgba(255,255,255,0.06);
  color:rgba(245,245,247,0.3);
  font-size:13px;font-weight:700;
  transition:all 0.3s ease;
}
.wizard-progress-step.active span{
  background:rgba(10,132,255,0.2);color:#0A84FF;
}
.wizard-progress-step.active{color:rgba(245,245,247,0.8)}
.wizard-progress-step.completed span{
  background:rgba(48,209,88,0.2);color:#30D158;
}
.wizard-progress-step.completed{color:rgba(245,245,247,0.5)}
.wizard-progress-line{
  flex:0 0 40px;height:2px;
  background:rgba(255,255,255,0.06);
  margin:0 12px;
  transition:background 0.3s ease;
}
.wizard-progress-line.active{background:rgba(10,132,255,0.4)}
.wiz-step{
  display:none;text-align:center;
  animation:fadeSlideUp 0.4s ease;
}
.wiz-step.active{display:block}
.wiz-step h3{
  font-size:20px;font-weight:600;margin-bottom:8px;
  color:rgba(245,245,247,0.9);
}
.wiz-step>p{
  font-size:15px;color:rgba(245,245,247,0.45);
  margin-bottom:24px;
}
.wiz-alt-token{margin-top:24px}
.wiz-alt-toggle{
  font-size:14px;color:rgba(245,245,247,0.35);
  text-decoration:underline;
  text-underline-offset:3px;
  transition:color 0.2s ease;
  background:none;border:none;cursor:pointer;
}
@media(hover:hover){.wiz-alt-toggle:hover{color:rgba(245,245,247,0.6)}}
.wiz-alt-input{
  display:flex;gap:8px;margin-top:12px;
  max-width:420px;margin-left:auto;margin-right:auto;
}
.wiz-alt-input input{
  flex:1;padding:10px 16px;
  font-size:14px;font-family:'SF Mono','Fira Code',monospace;
  color:#F5F5F7;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;outline:none;
  transition:border-color 0.2s ease;
}
.wiz-alt-input input:focus{border-color:rgba(10,132,255,0.4)}
.wiz-alt-input button{
  padding:10px 20px;border-radius:8px;
  font-size:14px;font-weight:600;
  color:#fff;background:#0A84FF;
  transition:background 0.2s ease;
}
@media(hover:hover){.wiz-alt-input button:hover{background:#409CFF}}
.wiz-next-btn{
  display:block;margin:24px auto 0;
  padding:16px 48px;
  font-size:18px;font-weight:600;
  color:#fff;
  background:linear-gradient(135deg,#0A84FF 0%,#5E5CE6 100%);
  border-radius:50px;
  box-shadow:0 0 24px rgba(10,132,255,0.3),0 0 64px rgba(94,92,230,0.15);
  transition:all 0.3s ease;
}
@media(hover:hover){.wiz-next-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 0 32px rgba(10,132,255,0.5),0 0 80px rgba(94,92,230,0.25);
}}
.wiz-next-btn:active{transform:scale(0.97)}
.wiz-link-btn{
  display:block;margin:12px auto 0;
  font-size:13px;color:rgba(245,245,247,0.35);
  text-decoration:underline;text-underline-offset:3px;
  background:none;border:none;cursor:pointer;
  transition:color 0.2s ease;
}
@media(hover:hover){.wiz-link-btn:hover{color:rgba(245,245,247,0.6)}}
.wiz-loading{
  text-align:center;padding:32px;
  color:rgba(245,245,247,0.4);font-size:15px;
}
.wizard-detected{
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(48,209,88,0.1);
  border:1px solid rgba(48,209,88,0.2);
  border-radius:50px;padding:6px 16px;
  font-size:13px;font-weight:500;
  color:rgba(245,245,247,0.7);
  margin-bottom:24px;
}
.wizard-detected::before{
  content:'';display:block;width:8px;height:8px;
  border-radius:50%;background:#30D158;
  box-shadow:0 0 6px rgba(48,209,88,0.5);
}
.wizard-unsupported{
  text-align:center;padding:32px 24px;
  background:rgba(255,69,58,0.08);
  border:1px solid rgba(255,69,58,0.15);
  border-radius:16px;
  color:rgba(245,245,247,0.7);font-size:15px;line-height:1.7;
}
.wizard-step{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:20px 24px;
  margin-bottom:12px;
}
.wizard-step-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:28px;height:28px;border-radius:50%;
  background:rgba(10,132,255,0.15);
  color:#0A84FF;font-size:13px;font-weight:700;
  margin-right:12px;flex-shrink:0;
}
.wizard-step-title{
  font-size:16px;font-weight:600;
  color:rgba(245,245,247,0.85);
  display:flex;align-items:center;
  margin-bottom:12px;
}
.wizard-command{
  position:relative;
  background:rgba(0,0,0,0.35);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:8px;padding:14px 48px 14px 16px;
  font-family:'SF Mono','Fira Code',monospace;
  font-size:13px;line-height:1.6;
  color:rgba(245,245,247,0.75);
  overflow-x:auto;white-space:pre-wrap;word-break:break-all;
}
.copy-btn{
  position:absolute;top:8px;right:8px;
  padding:4px 10px;border-radius:6px;
  font-size:11px;font-weight:600;
  color:rgba(245,245,247,0.4);
  background:rgba(255,255,255,0.06);
  transition:all 0.2s ease;
  cursor:pointer;
}
@media(hover:hover){.copy-btn:hover{color:#F5F5F7;background:rgba(255,255,255,0.1)}}
.copy-btn.copied{color:#30D158;background:rgba(48,209,88,0.15)}

.faq-section{margin-top:48px}
.faq-item{margin-bottom:24px}
.faq-item h4{font-size:16px;font-weight:600;margin-bottom:8px;color:rgba(245,245,247,0.85)}
.faq-item p{font-size:15px;color:rgba(245,245,247,0.5);line-height:1.7}

/* ── MEET PAGE ────────────────────────────────────────────────────────────── */
.meet-content{
  max-width:960px;margin:0 auto;
  padding:72px 24px 24px;
  display:flex;gap:24px;
  min-height:calc(100vh - 56px);
  min-height:calc(100dvh - 56px);
}
.meet-face-col{
  flex:0 0 360px;
  display:flex;flex-direction:column;gap:16px;
}
.face-container{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;overflow:hidden;
  position:relative;
  aspect-ratio:1;
}
.face-container canvas{display:block;width:100%;height:100%}
.face-edge-glow{
  position:absolute;top:0;left:0;right:0;bottom:0;
  pointer-events:none;border-radius:16px;
  box-shadow:inset 0 0 20px 10px rgba(70,130,255,0.0);
  transition:box-shadow 0.3s ease;
}
.meet-stats{
  display:flex;flex-wrap:wrap;gap:8px;
}
.stat-badge{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:8px;padding:8px 14px;
  font-size:12px;color:rgba(245,245,247,0.5);
  font-family:'SF Mono','Fira Code',monospace;
  display:flex;align-items:center;gap:6px;
}
.stat-badge .stat-dot{width:6px;height:6px;border-radius:50%;background:#30D158}
.stat-badge .stat-dot.warn{background:#FFD60A}
.stat-badge .stat-dot.danger{background:#FF453A}
.stat-badge .stat-dot.offline{background:rgba(245,245,247,0.2)}
.meet-thought{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:14px 16px;
  font-size:13px;color:rgba(245,245,247,0.4);
  font-style:italic;min-height:48px;
  display:flex;align-items:center;
}

/* Chat Column */
.meet-chat-col{
  flex:1;display:flex;flex-direction:column;
  min-width:0;
}
.chat-messages{
  flex:1;overflow-y:auto;
  padding:8px 0;
  display:flex;flex-direction:column;gap:12px;
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,0.1) transparent;
}
.chat-messages::-webkit-scrollbar{width:4px}
.chat-messages::-webkit-scrollbar-track{background:transparent}
.chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px}
.chat-bubble{
  max-width:85%;padding:14px 18px;
  border-radius:18px;font-size:15px;line-height:1.6;
  animation:fadeSlideUp 0.3s ease;
  word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;
  overflow-x:auto;
}
.chat-bubble.user{
  align-self:flex-end;
  background:rgba(10,132,255,0.2);
  border:1px solid rgba(10,132,255,0.15);
  border-bottom-right-radius:6px;
  color:rgba(245,245,247,0.9);
}
.chat-bubble.assistant{
  align-self:flex-start;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.06);
  border-bottom-left-radius:6px;
  color:rgba(245,245,247,0.8);
}
.chat-bubble.system{
  align-self:center;
  background:transparent;
  font-size:13px;color:rgba(245,245,247,0.3);
  padding:8px;
}
.chat-input-area{
  display:flex;gap:8px;
  padding-top:16px;
  border-top:1px solid rgba(255,255,255,0.06);
  margin-top:8px;
}
.chat-input{
  flex:1;
  padding:12px 18px;
  font-size:15px;font-family:inherit;
  color:#F5F5F7;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:24px;
  outline:none;
  transition:all 0.2s ease;
  min-height:44px;
}
.chat-input::placeholder{color:rgba(245,245,247,0.3)}
.chat-input:focus{
  background:rgba(255,255,255,0.08);
  border-color:rgba(10,132,255,0.3);
}
.chat-send{
  width:44px;height:44px;border-radius:50%;
  background:#0A84FF;color:#fff;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s ease;flex-shrink:0;
}
@media(hover:hover){.chat-send:hover{background:#409CFF}}
.chat-send:disabled{background:rgba(10,132,255,0.3);cursor:not-allowed}
.chat-send svg{width:18px;height:18px}

/* ── CONNECT PAGE ─────────────────────────────────────────────────────────── */
.connect-content{max-width:800px;margin:0 auto;padding:80px 24px 64px}
.connect-hero{text-align:center;margin-bottom:48px}
.connect-hero h1{
  font-size:clamp(1.8rem,4vw,2.5rem);font-weight:700;
  letter-spacing:-0.02em;margin-bottom:12px;
}
.connect-hero p{font-size:16px;color:rgba(245,245,247,0.45)}
.network-overview{
  display:flex;gap:16px;margin-bottom:40px;flex-wrap:wrap;
}
.network-stat{
  flex:1;min-width:140px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:20px;
  text-align:center;
}
.network-stat .stat-value{
  font-size:clamp(1.5rem,4vw,2rem);font-weight:700;
  color:#F5F5F7;margin-bottom:4px;
}
.network-stat .stat-label{
  font-size:13px;color:rgba(245,245,247,0.35);
}
.node-list{margin-bottom:40px}
.node-card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:20px 24px;
  margin-bottom:8px;
  display:flex;align-items:center;gap:16px;
}
.node-indicator{
  width:12px;height:12px;border-radius:50%;
  background:#30D158;flex-shrink:0;
  box-shadow:0 0 8px rgba(48,209,88,0.4);
  animation:pulse-node 2s ease infinite;
}
.node-indicator.offline{background:rgba(245,245,247,0.2);box-shadow:none;animation:none}
@keyframes pulse-node{0%,100%{box-shadow:0 0 8px rgba(48,209,88,0.4)}50%{box-shadow:0 0 16px rgba(48,209,88,0.6)}}
.node-info{flex:1}
.node-name{font-weight:600;font-size:16px;margin-bottom:2px}
.node-meta{font-size:13px;color:rgba(245,245,247,0.4)}
.node-model{
  font-family:'SF Mono','Fira Code',monospace;
  font-size:12px;color:rgba(10,132,255,0.7);
  background:rgba(10,132,255,0.1);
  padding:4px 10px;border-radius:6px;
}
.network-health{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;padding:24px;
}
.health-title{font-size:14px;color:rgba(245,245,247,0.4);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.05em}
.health-bar{
  height:8px;background:rgba(255,255,255,0.06);
  border-radius:4px;overflow:hidden;margin-bottom:8px;
}
.health-fill{
  height:100%;border-radius:4px;
  background:linear-gradient(90deg,#30D158,#0A84FF);
  transition:width 0.5s ease;
}
.health-label{font-size:13px;color:rgba(245,245,247,0.35)}

/* ── DASHBOARD PAGE ──────────────────────────────────────────────────────── */
.dash-content{max-width:960px;margin:0 auto;padding:80px 24px 64px}
.dash-hero{text-align:center;margin-bottom:40px}
.dash-hero h1{
  font-size:clamp(1.8rem,4vw,2.5rem);font-weight:700;
  letter-spacing:-0.02em;margin-bottom:8px;
}
.dash-hero p{font-size:15px;color:rgba(245,245,247,0.45)}
.dash-overview{
  display:flex;gap:12px;margin-bottom:40px;flex-wrap:wrap;
}
.dash-stat{
  flex:1;min-width:120px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:20px;text-align:center;
}
.dash-stat .stat-value{
  font-size:clamp(1.5rem,4vw,2rem);font-weight:700;
  color:#F5F5F7;margin-bottom:4px;
}
.dash-stat .stat-label{font-size:12px;color:rgba(245,245,247,0.35)}
.dash-table-wrap{overflow-x:auto;margin-bottom:24px}
.dash-table{
  width:100%;border-collapse:collapse;
  font-size:14px;color:rgba(245,245,247,0.75);
}
.dash-table th{
  text-align:left;padding:10px 12px;
  font-size:12px;font-weight:600;
  color:rgba(245,245,247,0.4);
  text-transform:uppercase;letter-spacing:0.04em;
  border-bottom:1px solid rgba(255,255,255,0.08);
  white-space:nowrap;
}
.dash-table td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.04);
  white-space:nowrap;
}
.dash-table tbody tr:hover{background:rgba(255,255,255,0.02)}
.dash-status-dot{
  display:inline-block;width:10px;height:10px;border-radius:50%;
  vertical-align:middle;
}
.dash-status-dot.online{
  background:#30D158;
  box-shadow:0 0 6px rgba(48,209,88,0.4);
}
.dash-status-dot.offline{
  background:rgba(245,245,247,0.2);box-shadow:none;
}
.role-badge{
  display:inline-block;
  font-size:11px;font-weight:600;
  padding:2px 8px;border-radius:4px;
  text-transform:uppercase;letter-spacing:0.03em;
}
.role-badge.inference{background:rgba(10,132,255,0.15);color:#409CFF}
.role-badge.monitor{background:rgba(255,214,10,0.15);color:#FFD60A}
.query-bar-wrap{
  width:80px;height:6px;
  background:rgba(255,255,255,0.06);
  border-radius:3px;overflow:hidden;
  display:inline-block;vertical-align:middle;
  margin-right:8px;
}
.query-bar{
  height:100%;border-radius:3px;
  background:linear-gradient(90deg,#0A84FF,#30D158);
  transition:width 0.5s ease;
}
.dash-footer{
  display:flex;justify-content:space-between;
  font-size:12px;color:rgba(245,245,247,0.25);
  padding-top:16px;
  border-top:1px solid rgba(255,255,255,0.04);
}
@media(max-width:768px){
  .dash-content{padding:72px 16px 48px}
  .dash-overview{flex-direction:column}
  .dash-table{font-size:13px}
  .dash-table th,.dash-table td{padding:8px 8px}
}
@media(max-width:480px){
  .dash-content{padding:68px 12px 40px}
}

/* ── Contributor Dashboard ─────────────────────────────────────────────────── */
.contrib-section{
  margin-bottom:32px;
  animation:fadeSlideUp 0.4s ease;
}
.contrib-section h2{
  font-size:clamp(1.3rem,3vw,1.8rem);font-weight:600;
  margin-bottom:16px;letter-spacing:-0.01em;
}
.contrib-card{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;padding:24px;
  margin-bottom:12px;
}
.contrib-card-header{
  display:flex;align-items:center;gap:12px;
  margin-bottom:16px;
}
.contrib-card-header .contrib-name{
  font-size:16px;font-weight:600;color:#F5F5F7;
}
.contrib-card-header .contrib-type{
  font-size:12px;color:rgba(245,245,247,0.35);
}
.contrib-pulse-dot{
  width:10px;height:10px;border-radius:50%;flex-shrink:0;
}
.contrib-pulse-dot.online{
  background:#30D158;
  box-shadow:0 0 6px rgba(48,209,88,0.5);
  animation:contrib-pulse 2s ease infinite;
}
.contrib-pulse-dot.offline{
  background:rgba(245,245,247,0.2);
}
@keyframes contrib-pulse{0%,100%{box-shadow:0 0 4px rgba(48,209,88,0.4)}50%{box-shadow:0 0 12px rgba(48,209,88,0.7)}}
.contrib-stats{
  display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;
}
.contrib-stat{
  flex:1;min-width:100px;
  text-align:center;
  padding:12px 8px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
}
.contrib-stat-value{font-size:18px;font-weight:700;color:#F5F5F7}
.contrib-stat-label{font-size:11px;color:rgba(245,245,247,0.35);margin-top:2px}
.contrib-power-selector{
  display:flex;gap:8px;margin-bottom:16px;
}
.contrib-power-btn{
  flex:1;padding:10px 8px;
  border-radius:10px;font-size:13px;font-weight:600;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.03);
  color:rgba(245,245,247,0.5);
  transition:all 0.2s ease;
  text-align:center;
}
@media(hover:hover){.contrib-power-btn:hover{background:rgba(255,255,255,0.06);color:#F5F5F7}}
.contrib-power-btn.active{
  border-color:rgba(10,132,255,0.4);
  background:rgba(10,132,255,0.12);
  color:#409CFF;
}
.contrib-remove-btn{
  display:block;width:100%;
  padding:10px;border-radius:10px;
  font-size:13px;font-weight:600;
  border:1px solid rgba(255,59,48,0.2);
  background:rgba(255,59,48,0.06);
  color:rgba(255,59,48,0.7);
  transition:all 0.2s ease;
}
@media(hover:hover){.contrib-remove-btn:hover{background:rgba(255,59,48,0.12);color:#FF453A}}
.contrib-signin{
  text-align:center;padding:32px 24px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;
  color:rgba(245,245,247,0.5);font-size:15px;
}
.contrib-signin a{color:#0A84FF;font-weight:500}
.contrib-no-node{
  text-align:center;padding:24px;
  color:rgba(245,245,247,0.4);font-size:14px;
}
.contrib-no-node a{color:#0A84FF}

/* ── Device Chooser (Step 0) ──────────────────────────────────────────────── */
.device-chooser{
  max-width:640px;margin:0 auto 48px;
  animation:fadeSlideUp 0.4s ease;
}
.device-chooser h3{
  font-size:20px;font-weight:600;margin-bottom:8px;
  color:rgba(245,245,247,0.9);text-align:center;
}
.device-chooser>p{
  font-size:15px;color:rgba(245,245,247,0.45);
  margin-bottom:24px;text-align:center;
}
.device-chooser-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
}
.device-choose-card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;padding:24px 20px;
  text-align:center;cursor:pointer;
  transition:all 0.3s ease;
  display:flex;flex-direction:column;align-items:center;gap:8px;
}
@media(hover:hover){.device-choose-card:hover{
  background:rgba(255,255,255,0.06);
  border-color:rgba(255,255,255,0.15);
  transform:translateY(-2px);
}}
.device-choose-card .device-choose-icon{font-size:32px;line-height:1}
.device-choose-card .device-choose-name{
  font-size:16px;font-weight:600;color:rgba(245,245,247,0.85);
}
.device-choose-card .device-choose-role{
  font-size:12px;font-weight:600;
  padding:2px 10px;border-radius:50px;
  display:inline-block;
}
.device-choose-role.inference{
  background:rgba(10,132,255,0.15);color:#0A84FF;
}
.device-choose-role.monitor{
  background:rgba(255,214,10,0.15);color:#FFD60A;
}
@media(max-width:480px){
  .device-chooser-grid{grid-template-columns:1fr;max-width:320px;margin:0 auto}
}

/* ── Monitor Status ──────────────────────────────────────────────────────── */
.monitor-status-card{
  background:rgba(48,209,88,0.06);
  border:1px solid rgba(48,209,88,0.2);
  border-radius:16px;padding:32px 24px;
  text-align:center;
  animation:fadeSlideUp 0.4s ease;
}
.monitor-pulse{
  display:inline-flex;align-items:center;gap:10px;
  font-size:18px;font-weight:600;color:#30D158;
  margin-bottom:16px;
}
.monitor-pulse-dot{
  width:12px;height:12px;border-radius:50%;
  background:#30D158;
  box-shadow:0 0 8px rgba(48,209,88,0.5);
  animation:pulse-monitor 2s ease infinite;
}
@keyframes pulse-monitor{
  0%,100%{box-shadow:0 0 8px rgba(48,209,88,0.5)}
  50%{box-shadow:0 0 20px rgba(48,209,88,0.8)}
}
.monitor-node-id{
  font-family:'SF Mono','Fira Code',monospace;
  font-size:13px;color:rgba(245,245,247,0.4);
  margin-bottom:20px;
}
.monitor-stop-btn{
  padding:10px 28px;border-radius:50px;
  font-size:14px;font-weight:600;
  color:rgba(245,245,247,0.6);
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  transition:all 0.2s ease;
}
@media(hover:hover){.monitor-stop-btn:hover{
  color:#FF453A;border-color:rgba(255,69,58,0.3);
  background:rgba(255,69,58,0.1);
}}
.monitor-badge{
  display:inline-flex;align-items:center;gap:8px;
  background:rgba(48,209,88,0.1);
  border:1px solid rgba(48,209,88,0.2);
  border-radius:50px;padding:6px 16px;
  font-size:13px;font-weight:500;
  color:rgba(245,245,247,0.7);
  margin-bottom:24px;
}
.monitor-badge::before{
  content:'';display:block;width:8px;height:8px;
  border-radius:50%;background:#30D158;
  box-shadow:0 0 6px rgba(48,209,88,0.5);
}
.start-monitor-btn{
  display:block;margin:24px auto 0;
  padding:16px 48px;
  font-size:18px;font-weight:600;
  color:#fff;
  background:linear-gradient(135deg,#30D158 0%,#34C759 100%);
  border-radius:50px;
  box-shadow:0 0 24px rgba(48,209,88,0.3),0 0 64px rgba(52,199,89,0.15);
  transition:all 0.3s ease;
}
@media(hover:hover){.start-monitor-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 0 32px rgba(48,209,88,0.5),0 0 80px rgba(52,199,89,0.25);
}}
.start-monitor-btn:active{transform:scale(0.97)}
.monitor-explain{
  font-size:14px;color:rgba(245,245,247,0.5);
  line-height:1.7;margin-bottom:20px;text-align:left;
}
.monitor-substep{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:12px;padding:16px 20px;
  margin-bottom:10px;text-align:left;
}
.monitor-substep-title{
  font-size:14px;font-weight:600;
  color:rgba(245,245,247,0.75);
  display:flex;align-items:center;gap:8px;margin-bottom:8px;
}
.monitor-substep-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:22px;height:22px;border-radius:50%;
  background:rgba(48,209,88,0.15);
  color:#30D158;font-size:11px;font-weight:700;flex-shrink:0;
}
.monitor-substep p{
  font-size:13px;color:rgba(245,245,247,0.45);line-height:1.6;
}

/* ── Power Mode Selector (in wizard Step 3) ──────────────────────────────── */
.power-selector{margin-bottom:24px}
.power-selector-label{
  font-size:14px;font-weight:600;
  color:rgba(245,245,247,0.6);margin-bottom:12px;
  text-align:left;
}
.power-selector-options{display:flex;gap:8px;flex-wrap:wrap}
.power-option{
  flex:1;min-width:140px;
  background:rgba(255,255,255,0.03);
  border:2px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:14px 12px;
  text-align:center;cursor:pointer;
  transition:all 0.2s ease;
}
@media(hover:hover){.power-option:hover{
  background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.15);
}}
.power-option.selected{
  border-color:rgba(10,132,255,0.5);
  background:rgba(10,132,255,0.08);
}
.power-option-icon{font-size:20px;margin-bottom:4px}
.power-option-name{font-size:13px;font-weight:600;color:rgba(245,245,247,0.8)}
.power-option-desc{font-size:11px;color:rgba(245,245,247,0.35);margin-top:2px}

/* ── Shared ───────────────────────────────────────────────────────────────── */
.section-divider{
  height:1px;background:rgba(255,255,255,0.06);
  margin:48px 0;
}
.error-toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:rgba(255,69,58,0.15);
  border:1px solid rgba(255,69,58,0.3);
  border-radius:12px;padding:12px 24px;
  font-size:14px;color:#FF453A;
  z-index:200;
  animation:fadeSlideUp 0.3s ease;
  display:none;
}
.error-toast.visible{display:block}

/* ── Responsive ───────────────────────────────────────────────────────────── */
@media(max-width:768px){
  .nav-tabs{display:none}
  .nav-hamburger{display:flex}
  .mobile-menu{display:block}
  .meet-content{flex-direction:column;padding-top:64px}
  .meet-face-col{flex:none;align-items:center}
  .face-container{width:100%;max-width:320px;aspect-ratio:1}
  .power-modes{flex-direction:column}
  .power-card{min-width:0}
  .network-overview{flex-direction:column}
}
@media(max-width:480px){
  #nav{padding:0 16px}
  .search-bar{padding:14px 52px 14px 20px;font-size:16px}
  .about-content,.start-content,.connect-content{padding:72px 16px 48px}
  .meet-content{padding:64px 16px 16px}
  .result-card{padding:20px}
}
@media(max-width:320px){
  .search-bar{padding:12px 48px 12px 16px;font-size:15px}
  .search-btn{width:40px;height:40px}
  .result-card{padding:16px}
  .about-content,.start-content,.connect-content{padding:64px 12px 40px}
  .power-modes{gap:12px}
  .chat-bubble{max-width:90%;padding:12px 14px;font-size:14px}
  .home-logo{margin-bottom:4px}
  .home-tagline{margin-bottom:24px}
}
@media(min-width:769px){
  .mobile-menu{display:none!important}
}
/* ── Token Card ───────────────────────────────────────────────────────── */
.google-signin-wrap{
  display:flex;justify-content:center;margin:16px 0;
}
.token-card{
  background:rgba(48,209,88,0.06);
  border:1px solid rgba(48,209,88,0.2);
  border-radius:16px;padding:28px 24px;
  margin-top:24px;animation:fadeSlideUp 0.4s ease;
  text-align:left;
}
.token-card-header{
  display:flex;align-items:center;gap:12px;
  margin-bottom:20px;
}
.token-card-avatar{
  width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,0.1);
}
.token-card-name{
  font-size:17px;font-weight:600;color:rgba(245,245,247,0.9);
}
.token-card-email{
  font-size:13px;color:rgba(245,245,247,0.4);
}
.token-card-label{
  font-size:12px;font-weight:600;letter-spacing:0.04em;
  text-transform:uppercase;color:rgba(245,245,247,0.35);
  margin-bottom:8px;
}
.token-card-value{
  position:relative;
  background:rgba(0,0,0,0.35);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:8px;padding:14px 60px 14px 16px;
  font-family:'SF Mono','Fira Code',monospace;
  font-size:14px;color:#30D158;
  word-break:break-all;line-height:1.5;
}
.token-card-value .copy-btn{
  position:absolute;top:10px;right:8px;
}
.token-card-hint{
  margin-top:12px;font-size:13px;
  color:rgba(245,245,247,0.4);line-height:1.6;
}
.token-card-actions{
  margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;
}
.token-revoke-btn{
  padding:8px 16px;border-radius:8px;
  font-size:13px;font-weight:500;
  color:rgba(255,69,58,0.7);
  background:rgba(255,69,58,0.08);
  border:1px solid rgba(255,69,58,0.15);
  transition:all 0.2s ease;
}
@media(hover:hover){.token-revoke-btn:hover{
  color:#FF453A;background:rgba(255,69,58,0.15);
}}

@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}
  #stars-canvas{display:none}
}
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<!-- Stars Background -->
<canvas id="stars-canvas"></canvas>

<!-- Navigation -->
<nav id="nav">
  <div class="nav-logo" onclick="navigateTo('/')">
    <div class="logo-eyes"><div class="logo-eye"></div><div class="logo-eye"></div></div>
    <span>Wattson</span>
  </div>
  <ul class="nav-tabs">
    <li class="nav-tab" data-page="about" onclick="navigateTo('/about')">About</li>
    <li class="nav-tab" data-page="start" onclick="navigateTo('/start')">Get Started</li>
    <li class="nav-tab" data-page="meet" onclick="navigateTo('/meet')">Meet Wattson</li>
    <li class="nav-tab" data-page="dashboard" onclick="navigateTo('/dashboard')">Dashboard</li>
  </ul>
  <button class="nav-hamburger" id="hamburger-btn" onclick="toggleMobileMenu()">
    <div class="hamburger-icon"><span></span><span></span><span></span></div>
  </button>
</nav>
<div class="mobile-menu" id="mobile-menu">
  <a class="mobile-menu-item" data-page="home" onclick="navigateTo('/');closeMobileMenu()">Home</a>
  <a class="mobile-menu-item" data-page="about" onclick="navigateTo('/about');closeMobileMenu()">About</a>
  <a class="mobile-menu-item" data-page="start" onclick="navigateTo('/start');closeMobileMenu()">Get Started</a>
  <a class="mobile-menu-item" data-page="meet" onclick="navigateTo('/meet');closeMobileMenu()">Meet Wattson</a>
  <a class="mobile-menu-item" data-page="dashboard" onclick="navigateTo('/dashboard');closeMobileMenu()">Dashboard</a>
</div>

<!-- Error Toast -->
<div class="error-toast" id="error-toast"></div>

<!-- ══════════════════════════════════════════════════════════════════════════ -->
<main>

<!-- HOME PAGE -->
<section class="page active visible" id="page-home">
  <div class="home-logo">Wattson</div>
  <div class="home-tagline">AI For the World &mdash; Powered by the devices you forgot about.</div>
  <div class="search-container">
    <input class="search-bar" id="search-input" type="text" placeholder="Ask anything..." autocomplete="off" maxlength="500" enterkeyhint="search">
    <div class="search-actions">
      <button class="search-btn" id="voice-btn" title="Voice search" style="display:none" onclick="toggleVoice()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <button class="search-btn primary" id="search-submit" title="Search" onclick="submitSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
      </button>
    </div>
  </div>
  <div class="device-count" id="device-count">Powered by <strong>1</strong> device worldwide</div>
  <div class="results-area" id="results-area"></div>
</section>

<!-- ABOUT PAGE -->
<section class="page" id="page-about">
  <div class="about-content">
    <div class="about-hero">
      <h1>Free AI, Powered by People</h1>
      <p>A kid in Africa with no ChatGPT can ask a question, and a global network of donated devices answers it.</p>
    </div>
    <div class="about-section">
      <h2>The Mission</h2>
      <p>AI should be free. Not free as in "free trial" &mdash; actually free. No account, no credit card, no subscription. Just ask and get an answer.</p>
      <p>Wattson is powered by ordinary devices that people around the world contribute to the network. Old phones, spare laptops, Raspberry Pis &mdash; the devices you forgot about, now doing something that matters.</p>
    </div>
    <div class="about-section">
      <h2>How It Works</h2>
      <div class="about-diagram">
        <div class="diagram-flow">
          <div class="diagram-node">You ask a question</div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-node">wattson.me (job queue)</div>
          <div class="diagram-arrow">&larr;</div>
          <div class="diagram-node">Device picks it up</div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-node">AI runs locally</div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-node">Answer comes back</div>
        </div>
      </div>
      <p>Every device in the network runs its own AI model using Ollama. When you ask a question, it goes into a queue. Contributor devices poll for new questions, process them on their local hardware, and send the answer back. The AI runs entirely on volunteer devices &mdash; no cloud, no data centers, no corporate servers.</p>
    </div>
    <div class="about-section">
      <h2>The Vision</h2>
      <p>Today, it's one phone answering questions. Tomorrow, it could be a million devices forming a global AI network that belongs to no corporation and serves everyone equally.</p>
      <ul>
        <li>Privacy-first: no corporate servers, no data collection, no tracking</li>
        <li>Censorship-resistant: no single entity controls the network</li>
        <li>Always free: powered by volunteers, not investors</li>
        <li>Open source: every line of code is public</li>
      </ul>
    </div>
    <div class="about-section">
      <h2>The Technology</h2>
      <p>Wattson uses <strong>Ollama</strong> to run AI models directly on consumer hardware. Modern small language models can run on almost anything &mdash; a phone with 2GB of RAM can answer your questions.</p>
      <ul>
        <li>Zero cloud dependency &mdash; AI runs on the metal</li>
        <li>Models optimized per device &mdash; from 0.6B parameters (phones) to 70B (desktops)</li>
        <li>Built-in redundancy &mdash; if one device goes offline, others pick up</li>
        <li>Zero npm dependencies &mdash; pure Node.js, runs anywhere</li>
      </ul>
    </div>
    <div class="about-footer">
      <p>Open source on <a href="https://github.com/chatde/wattson-me" target="_blank" rel="noopener">GitHub</a></p>
      <p style="margin-top:8px">A project by GHB Ventures</p>
    </div>
  </div>
</section>

<!-- START PAGE -->
<section class="page" id="page-start">
  <div class="start-content">
    <div class="start-hero">
      <h1>Contribute Your Device</h1>
      <p>Plug it in. Connect it. It contributes. That simple.</p>
    </div>
    <div class="contribute-wizard" id="contribute-wizard">
      <div class="device-chooser" id="device-chooser">
        <h3>What device are you contributing?</h3>
        <p>Every piece of hardware fits somewhere in the puzzle.</p>
        <div class="device-chooser-grid">
          <div class="device-choose-card" onclick="selectDevice('iphone')">
            <div class="device-choose-icon">&#128241;</div>
            <div class="device-choose-name">iPhone / iPad</div>
            <div class="device-choose-role monitor">Monitor Node</div>
          </div>
          <div class="device-choose-card" onclick="selectDevice('android')">
            <div class="device-choose-icon">&#128242;</div>
            <div class="device-choose-name">Android Phone</div>
            <div class="device-choose-role inference">AI Node</div>
          </div>
          <div class="device-choose-card" onclick="selectDevice('desktop')">
            <div class="device-choose-icon">&#128187;</div>
            <div class="device-choose-name">Mac / Windows / Linux</div>
            <div class="device-choose-role inference">AI Node</div>
          </div>
          <div class="device-choose-card" onclick="selectDevice('pi')">
            <div class="device-choose-icon">&#129302;</div>
            <div class="device-choose-name">Raspberry Pi</div>
            <div class="device-choose-role inference">AI Node</div>
          </div>
        </div>
      </div>
      <div class="wizard-progress" id="wizard-progress" style="display:none">
        <div class="wizard-progress-step" id="wp-1"><span>1</span> Get Token</div>
        <div class="wizard-progress-line" id="wpl-1"></div>
        <div class="wizard-progress-step" id="wp-2"><span>2</span> Your Token</div>
        <div class="wizard-progress-line" id="wpl-2"></div>
        <div class="wizard-progress-step" id="wp-3"><span>3</span> Start</div>
      </div>
      <div class="wiz-step" id="wiz-step-1">
        <h3>Get Your Token</h3>
        <p>Sign in to generate a unique contributor token for your device.</p>
        <div class="google-signin-wrap">
          <div id="g_id_onload"
            data-client_id=""
            data-callback="handleGoogleSignIn"
            data-auto_prompt="false">
          </div>
          <div class="g_id_signin"
            data-type="standard"
            data-shape="pill"
            data-theme="filled_black"
            data-text="signin_with"
            data-size="large"
            data-logo_alignment="left">
          </div>
        </div>
        <div class="wiz-alt-token">
          <button class="wiz-alt-toggle" onclick="toggleManualToken()">Already have a token?</button>
          <div class="wiz-alt-input" id="wiz-alt-input" style="display:none">
            <input type="text" id="manual-token-input" placeholder="Paste your token here..." maxlength="128">
            <button onclick="pasteToken()">Use Token</button>
          </div>
        </div>
      </div>
      <div class="wiz-step" id="wiz-step-2">
        <div id="wiz-token-card"></div>
        <button class="wiz-next-btn" onclick="advanceWizard(3)">Next &mdash; Get Setup Command</button>
        <button class="wiz-link-btn" onclick="useAnotherAccount()">Use a different account</button>
      </div>
      <div class="wiz-step" id="wiz-step-3">
        <div id="wiz-setup-content">
          <div class="wiz-loading">Detecting your device...</div>
        </div>
      </div>
    </div>
    <h2 class="section-title">Power Modes</h2>
    <p style="color:rgba(245,245,247,0.5);margin-bottom:24px;font-size:15px">You choose how much to give. Switch anytime.</p>
    <div class="power-modes">
      <div class="power-card full">
        <div class="power-icon">&#9889;</div>
        <h3>Full Force</h3>
        <p>Device dedicated 100% to the network. Max model, max context. Best performance.</p>
        <div class="power-best">Best for: plugged-in phones, old laptops, always-on Pis</div>
      </div>
      <div class="power-card half">
        <div class="power-icon">&#9881;</div>
        <h3>Half Force</h3>
        <p>Share resources. Still browse, watch videos. Smaller model, yields to your apps.</p>
        <div class="power-best">Best for: phone you're still using during the day</div>
      </div>
      <div class="power-card eco">
        <div class="power-icon">&#127807;</div>
        <h3>Eco Mode</h3>
        <p>Minimal contribution. Only answers when device is idle. Pauses when you open an app.</p>
        <div class="power-best">Best for: your daily phone &mdash; no slowdowns</div>
      </div>
    </div>
    <div class="section-divider"></div>
    <h2 class="section-title">What Can Join?</h2>
    <div class="device-grid">
      <div class="device-tag">iPhone / iPad (Monitor)</div>
      <div class="device-tag">Android Phones</div>
      <div class="device-tag">Raspberry Pi (1GB+)</div>
      <div class="device-tag">Old Laptops</div>
      <div class="device-tag">Desktops</div>
      <div class="device-tag">Mac / Linux / Windows</div>
      <div class="device-tag">Any device with Ollama</div>
    </div>
    <div class="section-divider"></div>
    <h2 class="section-title">Detailed Setup Guides</h2>
    <div class="setup-guides">
      <div class="setup-item">
        <div class="setup-header" onclick="toggleSetup(this)">
          <span>iPhone / iPad (Monitor Node)</span>
          <span class="setup-chevron">&#9660;</span>
        </div>
        <div class="setup-body"><div class="setup-body-inner">
          <p>iPhones and iPads can't run Ollama, but they're perfect as <strong>monitor nodes</strong> &mdash; they track which devices are online, network health, and response times.</p>
          <p><strong>1.</strong> Open this page on your iPhone/iPad in Safari</p>
          <p><strong>2.</strong> Tap <strong>Share</strong> &rarr; <strong>"Add to Home Screen"</strong> to install as a PWA</p>
          <p><strong>3.</strong> Choose "iPhone / iPad" from the device picker at the top, sign in, and tap "Start Monitoring"</p>
          <p>Your device will heartbeat every 30 seconds to keep its spot in the network. No battery drain &mdash; it's just a tiny HTTP request.</p>
        </div></div>
      </div>
      <div class="setup-item">
        <div class="setup-header" onclick="toggleSetup(this)">
          <span>Android (Termux + Ollama)</span>
          <span class="setup-chevron">&#9660;</span>
        </div>
        <div class="setup-body"><div class="setup-body-inner">
          <p><strong>1.</strong> Install <a href="https://f-droid.org/en/packages/com.termux/" target="_blank" rel="noopener">Termux</a> from F-Droid (not Play Store)</p>
          <p><strong>2.</strong> Open Termux and run:</p>
          <pre>pkg update &amp;&amp; pkg install ollama
ollama serve &amp;</pre>
          <p><strong>3.</strong> Pull a model for your device:</p>
          <pre># 2-4GB RAM:
ollama pull qwen3:1.7b

# Under 2GB RAM:
ollama pull qwen3:0.6b</pre>
          <p><strong>4.</strong> Download and run the contributor client:</p>
          <pre># Download the client
curl -O https://raw.githubusercontent.com/chatde/wattson-me/main/wattson-client.js

# Run it (replace YOUR_TOKEN with your token)
WATTSON_SERVER=https://wattson.me \
NODE_SECRET=YOUR_TOKEN \
MODEL=qwen3:1.7b \
node wattson-client.js</pre>
          <p>The client registers your device, polls for questions, runs them on your local Ollama, and sends answers back. It runs until you stop it (Ctrl+C).</p>
          <p>Don't have a token? <a href="/start" onclick="event.preventDefault();navigateTo('/start');window.scrollTo(0,0)">Sign in with Google</a> at the top of this page to get one.</p>
        </div></div>
      </div>
      <div class="setup-item">
        <div class="setup-header" onclick="toggleSetup(this)">
          <span>Linux / Raspberry Pi</span>
          <span class="setup-chevron">&#9660;</span>
        </div>
        <div class="setup-body"><div class="setup-body-inner">
          <p><strong>1.</strong> Install Ollama:</p>
          <pre>curl -fsSL https://ollama.ai/install.sh | sh</pre>
          <p><strong>2.</strong> Pull a model:</p>
          <pre># Pi 3 (1GB): qwen3:0.6b
# Pi 4 (2-4GB): qwen3:1.7b
# Laptop (8GB+): llama3.1:8b-q4

ollama pull qwen3:1.7b</pre>
          <p><strong>3.</strong> Download and run the contributor client:</p>
          <pre># Download the client
curl -O https://raw.githubusercontent.com/chatde/wattson-me/main/wattson-client.js

# Run it (replace YOUR_TOKEN with your token)
WATTSON_SERVER=https://wattson.me \
NODE_SECRET=YOUR_TOKEN \
MODEL=qwen3:1.7b \
node wattson-client.js</pre>
          <p>The client handles everything: registration, polling for questions, running Ollama, and sending answers back.</p>
          <p>Don't have a token? <a href="/start" onclick="event.preventDefault();navigateTo('/start');window.scrollTo(0,0)">Sign in with Google</a> at the top of this page to get one.</p>
        </div></div>
      </div>
      <div class="setup-item">
        <div class="setup-header" onclick="toggleSetup(this)">
          <span>Mac</span>
          <span class="setup-chevron">&#9660;</span>
        </div>
        <div class="setup-body"><div class="setup-body-inner">
          <p><strong>1.</strong> Install Ollama:</p>
          <pre>brew install ollama</pre>
          <p><strong>2.</strong> Pull a model:</p>
          <pre># 8GB: llama3.1:8b-q4
# 16GB+: qwen2.5:14b-q4
ollama pull llama3.1:8b-q4</pre>
          <p><strong>3.</strong> Download and run the contributor client:</p>
          <pre># Download the client
curl -O https://raw.githubusercontent.com/chatde/wattson-me/main/wattson-client.js

# Run it (replace YOUR_TOKEN with your token)
WATTSON_SERVER=https://wattson.me \
NODE_SECRET=YOUR_TOKEN \
MODEL=llama3.1:8b-q4 \
node wattson-client.js</pre>
          <p>The client handles everything: registration, polling for questions, running Ollama, and sending answers back.</p>
          <p>Don't have a token? <a href="/start" onclick="event.preventDefault();navigateTo('/start');window.scrollTo(0,0)">Sign in with Google</a> at the top of this page to get one.</p>
        </div></div>
      </div>
      <div class="setup-item">
        <div class="setup-header" onclick="toggleSetup(this)">
          <span>Windows</span>
          <span class="setup-chevron">&#9660;</span>
        </div>
        <div class="setup-body"><div class="setup-body-inner">
          <p><strong>1.</strong> Download Ollama from <a href="https://ollama.ai/download" target="_blank" rel="noopener">ollama.ai</a></p>
          <p><strong>2.</strong> Install and open a terminal (PowerShell):</p>
          <pre>ollama pull llama3.1:8b-q4</pre>
          <p><strong>3.</strong> Download and run the contributor client:</p>
          <pre># Download the client
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/chatde/wattson-me/main/wattson-client.js" -OutFile "wattson-client.js"

# Run it (replace YOUR_TOKEN with your token)
$env:WATTSON_SERVER="https://wattson.me"
$env:NODE_SECRET="YOUR_TOKEN"
$env:MODEL="llama3.1:8b-q4"
node wattson-client.js</pre>
          <p>The client handles everything: registration, polling for questions, running Ollama, and sending answers back.</p>
          <p>Don't have a token? <a href="/start" onclick="event.preventDefault();navigateTo('/start');window.scrollTo(0,0)">Sign in with Google</a> at the top of this page to get one.</p>
        </div></div>
      </div>
    </div>
    <div class="section-divider"></div>
    <div class="faq-section">
      <h2 class="section-title">FAQ</h2>
      <div class="faq-item">
        <h4>Will this slow down my phone?</h4>
        <p>In Eco Mode, Wattson only works when your phone is idle. You won't notice it. In Full Force, the device is dedicated to the network &mdash; best for phones you're not actively using.</p>
      </div>
      <div class="faq-item">
        <h4>Is my data safe?</h4>
        <p>Yes. Your query travels to a volunteer's device for processing, then disappears. We use Fog Logging &mdash; we record that a conversation happened (how long, what topic), but the actual words are never stored. No accounts, no tracking. IP addresses are hashed and never stored in plain text.</p>
      </div>
      <div class="faq-item">
        <h4>What's the minimum device spec?</h4>
        <p>2GB RAM for phones, 1GB for Raspberry Pi. Any laptop or desktop made in the last 10 years works. The network auto-selects the best model for your hardware.</p>
      </div>
      <div class="faq-item">
        <h4>Can I earn from contributing?</h4>
        <p>Revenue sharing is planned for Phase 3. Contributors will earn proportional to their uptime and power mode. More contribution = more earnings.</p>
      </div>
    </div>
  </div>
</section>

<!-- MEET PAGE -->
<section class="page" id="page-meet">
  <div class="meet-content">
    <div class="meet-face-col">
      <div class="face-container" id="face-container">
        <canvas id="wattson-face"></canvas>
        <div class="face-edge-glow" id="face-edge-glow"></div>
      </div>
      <div class="meet-stats" id="meet-stats">
        <div class="stat-badge"><span class="stat-dot" id="stat-dot-network"></span><span id="stat-network">Checking...</span></div>
      </div>
      <div class="meet-thought" id="meet-thought">Powered by volunteers around the world.</div>
    </div>
    <div class="meet-chat-col">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-bubble system">Say hello to Wattson &mdash; an AI that lives on a real phone.</div>
      </div>
      <div class="chat-input-area">
        <input class="chat-input" id="chat-input" type="text" placeholder="Type a message..." maxlength="500" enterkeyhint="send">
        <button class="chat-send" id="chat-send" onclick="sendChatMessage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- CONNECT PAGE -->
<section class="page" id="page-connect">
  <div class="connect-content">
    <div class="connect-hero">
      <h1>Network Status</h1>
      <p>Live view of the Wattson network</p>
    </div>
    <div class="network-overview" id="network-overview">
      <div class="network-stat">
        <div class="stat-value" id="net-devices">-</div>
        <div class="stat-label">Devices Online</div>
      </div>
      <div class="network-stat">
        <div class="stat-value" id="net-queries">-</div>
        <div class="stat-label">Queries Served</div>
      </div>
      <div class="network-stat">
        <div class="stat-value" id="net-version">-</div>
        <div class="stat-label">Network Version</div>
      </div>
    </div>
    <h2 class="section-title">Active Nodes</h2>
    <div class="node-list" id="node-list"></div>
    <div class="network-health">
      <div class="health-title">Network Health</div>
      <div class="health-bar"><div class="health-fill" id="health-fill" style="width:0%"></div></div>
      <div class="health-label" id="health-label">Checking...</div>
    </div>
  </div>
</section>

<!-- DASHBOARD PAGE -->
<section class="page" id="page-dashboard">
  <div class="dash-content">
    <div class="dash-hero">
      <h1>Network Dashboard</h1>
      <p>Real-time node stats &amp; health monitoring</p>
    </div>
    <div class="contrib-section" id="contrib-dashboard" style="display:none"></div>
    <div class="dash-overview" id="dash-overview">
      <div class="dash-stat">
        <div class="stat-value" id="dash-total-nodes">-</div>
        <div class="stat-label">Total Nodes</div>
      </div>
      <div class="dash-stat">
        <div class="stat-value" id="dash-inference-online">-</div>
        <div class="stat-label">Inference Online</div>
      </div>
      <div class="dash-stat">
        <div class="stat-value" id="dash-pending-jobs">-</div>
        <div class="stat-label">Pending Jobs</div>
      </div>
      <div class="dash-stat">
        <div class="stat-value" id="dash-total-queries">-</div>
        <div class="stat-label">Queries Served</div>
      </div>
    </div>
    <h2 class="section-title">Node Status</h2>
    <div class="dash-table-wrap">
      <table class="dash-table" id="dash-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Node</th>
            <th>Role</th>
            <th>Queries</th>
            <th>Avg Response</th>
            <th>Last Seen</th>
          </tr>
        </thead>
        <tbody id="dash-table-body"></tbody>
      </table>
    </div>
    <div class="dash-footer">
      <span id="dash-refresh-label">Auto-refreshes every 10s</span>
      <span>Network v<span id="dash-version">-</span></span>
    </div>
  </div>
</section>

</main>

<script>
/* ══════════════════════════════════════════════════════════════════════════════
   Wattson.me — Single Page Application
   Zero dependencies. Pure JavaScript.
   ══════════════════════════════════════════════════════════════════════════════ */

// ── SPA Router ───────────────────────────────────────────────────────────────

var currentPage = 'home';
var pageMap = { '/': 'home', '/about': 'about', '/start': 'start', '/meet': 'meet', '/connect': 'connect', '/dashboard': 'dashboard' };

function navigateTo(path) {
  var pageName = pageMap[path] || 'home';
  if (pageName === currentPage) return;
  showPage(pageName);
  history.pushState({ page: pageName }, '', path);
}

function showPage(pageName) {
  // Fade out current
  var pages = document.querySelectorAll('.page');
  for (var i = 0; i < pages.length; i++) pages[i].classList.remove('visible');

  setTimeout(function() {
    for (var j = 0; j < pages.length; j++) pages[j].classList.remove('active');
    var target = document.getElementById('page-' + pageName);
    if (target) {
      target.classList.add('active');
      requestAnimationFrame(function() {
        target.classList.add('visible');
        // Init page-specific content after display is applied
        if (pageName === 'meet') initFace();
        if (pageName === 'connect') loadNetwork();
        if (pageName === 'dashboard') loadDashboard();
      });
    }
  }, 150);

  currentPage = pageName;

  // Update nav
  var tabs = document.querySelectorAll('.nav-tab');
  for (var k = 0; k < tabs.length; k++) {
    tabs[k].classList.toggle('active', tabs[k].getAttribute('data-page') === pageName);
  }
  var mItems = document.querySelectorAll('.mobile-menu-item');
  for (var m = 0; m < mItems.length; m++) {
    mItems[m].classList.toggle('active', mItems[m].getAttribute('data-page') === pageName);
  }
  window.scrollTo(0, 0);
}

window.addEventListener('popstate', function(e) {
  var pageName = (e.state && e.state.page) ? e.state.page : pageMap[location.pathname] || 'home';
  showPage(pageName);
});

// Init from URL
(function() {
  var initial = pageMap[location.pathname] || 'home';
  currentPage = initial;
  var pages = document.querySelectorAll('.page');
  for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active', 'visible');
  var target = document.getElementById('page-' + initial);
  if (target) { target.classList.add('active', 'visible'); }
  var tabs = document.querySelectorAll('.nav-tab');
  for (var j = 0; j < tabs.length; j++) {
    tabs[j].classList.toggle('active', tabs[j].getAttribute('data-page') === initial);
  }
  history.replaceState({ page: initial }, '', location.pathname);
  if (initial === 'meet') setTimeout(initFace, 100);
  if (initial === 'connect') setTimeout(loadNetwork, 100);
  if (initial === 'dashboard') setTimeout(loadDashboard, 100);
})();

// ── Mobile Menu ──────────────────────────────────────────────────────────────

function toggleMobileMenu() {
  document.getElementById('hamburger-btn').classList.toggle('open');
  document.getElementById('mobile-menu').classList.toggle('open');
}
function closeMobileMenu() {
  document.getElementById('hamburger-btn').classList.remove('open');
  document.getElementById('mobile-menu').classList.remove('open');
}

// ── Nav Scroll Effect ────────────────────────────────────────────────────────

window.addEventListener('scroll', function() {
  document.getElementById('nav').classList.toggle('scrolled', window.scrollY > 20);
}, { passive: true });

// ── Stars Background ─────────────────────────────────────────────────────────

(function() {
  var canvas = document.getElementById('stars-canvas');
  var ctx = canvas.getContext('2d');
  var stars = [];
  var STAR_COUNT = 150;
  var dpr = window.devicePixelRatio || 1;
  var w, h, isVisible = true;

  function resize() {
    w = window.innerWidth; h = window.innerHeight;
    canvas.width = w * dpr; canvas.height = h * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function create() {
    stars = [];
    for (var i = 0; i < STAR_COUNT; i++) {
      stars.push({
        x: Math.random() * w, y: Math.random() * h,
        size: Math.random() * 1.5 + 0.3,
        baseOp: Math.random() * 0.6 + 0.15,
        twSpeed: Math.random() * 1.5 + 0.5,
        twPhase: Math.random() * Math.PI * 2,
        dx: (Math.random() - 0.5) * 0.08,
        dy: (Math.random() - 0.5) * 0.04,
        hue: Math.random() < 0.15 ? 1 : (Math.random() < 0.3 ? 2 : 0),
      });
    }
  }

  resize(); create();
  window.addEventListener('resize', function() { resize(); create(); });
  document.addEventListener('visibilitychange', function() {
    isVisible = !document.hidden;
    if (isVisible) requestAnimationFrame(draw);
  });

  var lastT = performance.now();
  function draw(ts) {
    if (!isVisible) return;
    var dt = (ts - lastT) / 1000; lastT = ts;
    ctx.clearRect(0, 0, w, h);
    for (var i = 0; i < stars.length; i++) {
      var s = stars[i];
      s.twPhase += dt * s.twSpeed;
      s.x += s.dx * dt; s.y += s.dy * dt;
      if (s.x < -2) s.x = w + 2; if (s.x > w + 2) s.x = -2;
      if (s.y < -2) s.y = h + 2; if (s.y > h + 2) s.y = -2;
      var op = s.baseOp + Math.sin(s.twPhase) * s.baseOp * 0.4;
      ctx.fillStyle = s.hue === 1 ? 'rgba(255,240,200,' + op.toFixed(3) + ')'
                    : s.hue === 2 ? 'rgba(180,210,255,' + op.toFixed(3) + ')'
                    : 'rgba(255,255,255,' + op.toFixed(3) + ')';
      ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

// ── Search Engine ────────────────────────────────────────────────────────────

var searchHistory = [];
var isSearching = false;
var searchInput = document.getElementById('search-input');
var resultsArea = document.getElementById('results-area');

searchInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitSearch(); }
});

function submitSearch() {
  var message = searchInput.value.trim();
  if (!message || isSearching) return;
  if (message.length > 500) { showError('Message must be under 500 characters'); return; }

  isSearching = true;
  document.getElementById('search-submit').disabled = true;
  document.getElementById('page-home').classList.add('has-results');

  var shimmer = document.createElement('div');
  shimmer.className = 'loading-shimmer'; shimmer.id = 'loading-shimmer';
  shimmer.innerHTML = '<div class="shimmer-line"></div><div class="shimmer-line"></div><div class="shimmer-line"></div>';
  resultsArea.prepend(shimmer);

  var historyForAPI = searchHistory.slice(-6).map(function(h) { return { role: h.role, text: h.text }; });

  fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: message, history: historyForAPI }),
  })
  .then(function(res) { return res.json().then(function(d) { return { status: res.status, data: d }; }); })
  .then(function(r) {
    var el = document.getElementById('loading-shimmer'); if (el) el.remove();
    if (r.status !== 200) { showError(r.data.error || 'Something went wrong'); return; }

    searchHistory.push({ role: 'user', text: message });
    searchHistory.push({ role: 'assistant', text: r.data.response });

    var card = document.createElement('div'); card.className = 'result-card';
    var qDiv = document.createElement('div'); qDiv.className = 'result-query'; qDiv.textContent = message;
    var tDiv = document.createElement('div'); tDiv.className = 'result-text';
    card.appendChild(qDiv); card.appendChild(tDiv);
    resultsArea.prepend(card);
    typeWriter(tDiv, r.data.response);
    searchInput.value = '';
  })
  .catch(function() {
    var el = document.getElementById('loading-shimmer'); if (el) el.remove();
    showError('Could not reach the network. Try again.');
  })
  .finally(function() {
    isSearching = false;
    document.getElementById('search-submit').disabled = false;
    searchInput.focus();
  });
}

function typeWriter(el, text, speed) {
  speed = speed || 20; var i = 0;
  var cursor = document.createElement('span'); cursor.className = 'cursor';
  el.textContent = ''; el.appendChild(cursor);
  function type() {
    if (i < text.length) { cursor.before(text.charAt(i)); i++; setTimeout(type, speed); }
    else { setTimeout(function() { cursor.remove(); }, 1500); }
  }
  type();
}

// ── Voice Input ──────────────────────────────────────────────────────────────

var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
var recognition = null, isListening = false;

if (SpeechRecognition) {
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (!(isIOS && isSafari)) {
    document.getElementById('voice-btn').style.display = 'flex';
    recognition = new SpeechRecognition();
    recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US';
    recognition.onresult = function(e) { searchInput.value = e.results[0][0].transcript; stopVoice(); submitSearch(); };
    recognition.onerror = function() { stopVoice(); };
    recognition.onend = function() { stopVoice(); };
  }
}

function toggleVoice() {
  if (isListening) { stopVoice(); return; }
  if (!recognition) return;
  isListening = true; document.getElementById('voice-btn').classList.add('listening');
  try { recognition.start(); } catch(e) { stopVoice(); }
}
function stopVoice() {
  isListening = false; document.getElementById('voice-btn').classList.remove('listening');
  if (recognition) try { recognition.stop(); } catch(e) { /* ok */ }
}

// ── Device Count ─────────────────────────────────────────────────────────────

function loadDeviceCount() {
  fetch('/api/network').then(function(r) { return r.json(); }).then(function(d) {
    var c = d.onlineCount || d.deviceCount || 1;
    document.getElementById('device-count').innerHTML = 'Powered by <strong>' + c + '</strong> device' + (c !== 1 ? 's' : '') + ' worldwide';
  }).catch(function() {});
}
loadDeviceCount();

// ── Face Renderer (Meet Page) ────────────────────────────────────────────────

var faceInited = false, faceCtx = null, faceCanvas = null;

var faceState = {
  eyeOpen: 0.5, pupilSize: 0.75, mouthCurve: 0.1,
  eyebrowAngle: 0, sparkle: false, sparkleOpacity: 0,
  blushIntensity: 0, blinkTimer: 0, isBlinking: false,
  nextBlink: 3000 + Math.random() * 4000, blinkDuration: 150,
  lookX: 0, lookY: 0, targetLookX: 0, targetLookY: 0,
  nextLookChange: 2000 + Math.random() * 5000,
  breathPhase: 0, talkPhase: 0, talking: false,
  jitterX: 0, jitterY: 0, sparklePhase: 0,
  edgeR: 70, edgeG: 130, edgeB: 255, edgePulseSpeed: 1,
  edgePulsePhase: 0, lastTime: 0,
};

function resizeFace() {
  var container = document.getElementById('face-container');
  if (!container || !faceCanvas || !faceCtx) return;
  var rect = container.getBoundingClientRect();
  if (rect.width === 0 || rect.height === 0) return;
  var dpr = window.devicePixelRatio || 1;
  faceCanvas.width = rect.width * dpr;
  faceCanvas.height = rect.height * dpr;
  faceCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function initFace() {
  if (faceInited) {
    // Already initialized — just resize in case page was hidden
    resizeFace();
    return;
  }
  faceCanvas = document.getElementById('wattson-face');
  if (!faceCanvas) return;
  faceCtx = faceCanvas.getContext('2d');
  faceInited = true;

  var container = document.getElementById('face-container');

  resizeFace();
  window.addEventListener('resize', resizeFace);

  container.addEventListener('mousemove', function(e) {
    var rect = container.getBoundingClientRect();
    faceState.targetLookX = ((e.clientX - rect.left) - rect.width / 2) / (rect.width / 2);
    faceState.targetLookY = ((e.clientY - rect.top) - rect.height * 0.42) / (rect.height * 0.42);
    faceState.nextLookChange = 2000;
  });
  container.addEventListener('mouseleave', function() {
    faceState.targetLookX = 0; faceState.targetLookY = 0;
  });
  container.addEventListener('click', function() {
    faceState.eyeOpen = 1.0; faceState.pupilSize = 1.1; faceState.mouthCurve = 0.3;
    faceState.sparkle = true;
    setTimeout(function() { faceState.sparkle = false; }, 2000);
  });

  faceState.lastTime = performance.now();
  requestAnimationFrame(drawFace);
  pollMeetState();
  setInterval(pollMeetState, 3000);
}

function lerp(a, b, t) { return a + (b - a) * Math.min(1, t); }
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

function drawFaceEye(cx, cy, r, open, pupilS, lx, ly, jx, jy, sparkOp) {
  var eyeH = r * Math.max(0.02, open), eyeW = r;

  faceCtx.save();
  faceCtx.beginPath();
  faceCtx.ellipse(cx, cy, eyeW, eyeH, 0, 0, Math.PI * 2);
  faceCtx.fillStyle = 'rgba(230,235,240,' + (0.9 + open * 0.1).toFixed(2) + ')';
  faceCtx.fill(); faceCtx.clip();

  var pr = r * 0.45 * pupilS, mo = r * 0.25;
  var px = cx + (lx + jx) * mo, py = cy + (ly + jy) * mo;
  var ir = pr * 1.6;

  var ig = faceCtx.createRadialGradient(px, py, pr * 0.3, px, py, ir);
  ig.addColorStop(0, '#2a5a8a'); ig.addColorStop(0.6, '#1a3a5a'); ig.addColorStop(1, '#0d2030');
  faceCtx.beginPath(); faceCtx.arc(px, py, ir, 0, Math.PI * 2); faceCtx.fillStyle = ig; faceCtx.fill();

  faceCtx.beginPath(); faceCtx.arc(px, py, pr, 0, Math.PI * 2);
  faceCtx.fillStyle = '#050510'; faceCtx.fill();

  faceCtx.beginPath(); faceCtx.arc(px - pr * 0.3, py - pr * 0.35, pr * 0.25, 0, Math.PI * 2);
  faceCtx.fillStyle = 'rgba(255,255,255,0.7)'; faceCtx.fill();

  if (sparkOp > 0.01) {
    var sps = [{ a: -0.8, d: 0.55, s: 0.12 }, { a: 1.8, d: 0.7, s: 0.09 }, { a: 2.8, d: 0.45, s: 0.1 }];
    for (var i = 0; i < sps.length; i++) {
      faceCtx.beginPath();
      faceCtx.arc(px + Math.cos(sps[i].a) * ir * sps[i].d, py + Math.sin(sps[i].a) * ir * sps[i].d, pr * sps[i].s, 0, Math.PI * 2);
      faceCtx.fillStyle = 'rgba(255,255,255,' + (sparkOp * 0.85).toFixed(3) + ')'; faceCtx.fill();
    }
  }
  faceCtx.restore();

  faceCtx.beginPath();
  faceCtx.ellipse(cx, cy - eyeH * 0.05, eyeW * 1.05, eyeH * 0.15, 0, Math.PI, 0);
  faceCtx.strokeStyle = 'rgba(200,210,220,0.3)'; faceCtx.lineWidth = 2; faceCtx.stroke();
}

function drawFaceEyebrow(cx, cy, er, angle, isLeft) {
  var bw = er * 1.15, bh = er * 0.22, yo = -er * 1.25;
  var ix = isLeft ? cx + bw * 0.5 : cx - bw * 0.5;
  var ox = isLeft ? cx - bw * 0.5 : cx + bw * 0.5;
  var by = cy + yo, iy = by - angle * bh * 2.5, oy = by + angle * bh * 0.5;
  faceCtx.beginPath(); faceCtx.moveTo(ox, oy);
  faceCtx.quadraticCurveTo((ix + ox) / 2, Math.min(iy, oy) - bh * 0.8, ix, iy);
  faceCtx.strokeStyle = 'rgba(200,210,225,0.45)';
  faceCtx.lineWidth = er * 0.08; faceCtx.lineCap = 'round'; faceCtx.stroke();
}

function drawFaceMouth(cx, cy, w, curve, talkOpen) {
  var hw = w / 2;
  if (talkOpen > 0.05) {
    var oh = talkOpen * w * 0.25, cp = cy + curve * w * 0.4;
    faceCtx.beginPath(); faceCtx.moveTo(cx - hw, cy);
    faceCtx.quadraticCurveTo(cx, cp - oh, cx + hw, cy);
    faceCtx.quadraticCurveTo(cx, cp + oh, cx - hw, cy);
    faceCtx.fillStyle = 'rgba(30,20,40,0.8)'; faceCtx.fill();
    faceCtx.strokeStyle = 'rgba(200,180,200,0.6)'; faceCtx.lineWidth = 2.5; faceCtx.stroke();
  } else {
    faceCtx.beginPath(); faceCtx.moveTo(cx - hw, cy);
    faceCtx.quadraticCurveTo(cx, cy + curve * w * 0.4, cx + hw, cy);
    faceCtx.strokeStyle = 'rgba(200,180,200,0.6)'; faceCtx.lineWidth = 3; faceCtx.stroke();
  }
}

function drawFace(ts) {
  if (!faceInited || currentPage !== 'meet') {
    if (faceInited) requestAnimationFrame(drawFace);
    return;
  }

  var dt = ts - faceState.lastTime; faceState.lastTime = ts;
  var dtS = dt / 1000; if (dtS > 0.1) dtS = 0.016;

  var container = document.getElementById('face-container');
  if (!container) { requestAnimationFrame(drawFace); return; }
  var rect = container.getBoundingClientRect();
  var w = rect.width, h = rect.height;

  var ls = 3 * dtS;
  faceState.eyeOpen = lerp(faceState.eyeOpen, 0.55, ls);
  faceState.pupilSize = lerp(faceState.pupilSize, clamp(0.8, 0.5, 1.5), ls);
  faceState.mouthCurve = lerp(faceState.mouthCurve, 0.1, ls);
  faceState.eyebrowAngle = lerp(faceState.eyebrowAngle, 0, 2 * dtS);
  faceState.sparkleOpacity = lerp(faceState.sparkleOpacity, faceState.sparkle ? 1 : 0, 2 * dtS);

  // Blink
  faceState.blinkTimer += dt;
  if (!faceState.isBlinking && faceState.blinkTimer > faceState.nextBlink) {
    faceState.isBlinking = true; faceState.blinkTimer = 0;
  }
  if (faceState.isBlinking && faceState.blinkTimer > faceState.blinkDuration) {
    faceState.isBlinking = false; faceState.blinkTimer = 0;
    faceState.nextBlink = 2500 + Math.random() * 5000;
  }
  var blinkMod = faceState.isBlinking ? Math.max(0, 1 - Math.sin(faceState.blinkTimer / faceState.blinkDuration * Math.PI)) : 1;

  // Look
  faceState.nextLookChange -= dt;
  if (faceState.nextLookChange <= 0) {
    faceState.targetLookX = (Math.random() - 0.5) * 1.5;
    faceState.targetLookY = (Math.random() - 0.5) * 0.8;
    faceState.nextLookChange = 1500 + Math.random() * 4000;
  }
  faceState.lookX = lerp(faceState.lookX, faceState.targetLookX, 2 * dtS);
  faceState.lookY = lerp(faceState.lookY, faceState.targetLookY, 2 * dtS);

  faceState.breathPhase += dtS * 1.2;
  faceState.talkPhase += dtS * 12;
  var talkOpen = faceState.talking ? 0.3 + Math.sin(faceState.talkPhase) * 0.3 + Math.sin(faceState.talkPhase * 2.7) * 0.15 : 0;
  faceState.jitterX = (Math.random() - 0.5) * 0.04;
  faceState.jitterY = (Math.random() - 0.5) * 0.04;
  faceState.sparklePhase += dtS * 4;
  var sparkFlicker = 0.5 + 0.5 * Math.sin(faceState.sparklePhase * 2.3) * Math.cos(faceState.sparklePhase * 1.7);

  faceCtx.fillStyle = '#080810'; faceCtx.fillRect(0, 0, w, h);

  var unit = Math.min(w, h) * 0.14;
  var faceCX = w / 2, faceCY = h * 0.42;
  var eyeSpacing = unit * 1.6, eyeR = unit * 0.75;
  var breathScale = 1 + Math.sin(faceState.breathPhase) * 0.008;

  faceCtx.save();
  faceCtx.translate(faceCX, faceCY);
  faceCtx.scale(breathScale, breathScale);
  faceCtx.translate(-faceCX, -faceCY);

  // Glow
  var glowR = unit * (1.8 + Math.sin(faceState.breathPhase) * 0.15);
  var gg = faceCtx.createRadialGradient(faceCX, faceCY, unit * 0.5, faceCX, faceCY, glowR);
  gg.addColorStop(0, 'rgba(' + Math.round(faceState.edgeR) + ',' + Math.round(faceState.edgeG) + ',' + Math.round(faceState.edgeB) + ',0.06)');
  gg.addColorStop(1, 'rgba(8,8,16,0)');
  faceCtx.beginPath(); faceCtx.arc(faceCX, faceCY, glowR, 0, Math.PI * 2);
  faceCtx.fillStyle = gg; faceCtx.fill();

  var lx = faceCX - eyeSpacing / 2, rx = faceCX + eyeSpacing / 2;
  var eOpen = faceState.eyeOpen * blinkMod;
  var sOp = faceState.sparkleOpacity * sparkFlicker;

  drawFaceEyebrow(lx, faceCY, eyeR, faceState.eyebrowAngle, true);
  drawFaceEyebrow(rx, faceCY, eyeR, faceState.eyebrowAngle, false);
  drawFaceEye(lx, faceCY, eyeR, eOpen, faceState.pupilSize, faceState.lookX, faceState.lookY, faceState.jitterX, faceState.jitterY, sOp);
  drawFaceEye(rx, faceCY, eyeR, eOpen, faceState.pupilSize, faceState.lookX, faceState.lookY, faceState.jitterX, faceState.jitterY, sOp);

  var mouthY = faceCY + unit * 1.3;
  drawFaceMouth(faceCX, mouthY, unit * 1.4, faceState.mouthCurve, talkOpen);

  faceCtx.restore();

  // Edge glow
  faceState.edgePulsePhase += dtS * faceState.edgePulseSpeed * Math.PI * 2;
  var ep = 0.1 + 0.15 * (0.5 + 0.5 * Math.sin(faceState.edgePulsePhase));
  var eGlow = document.getElementById('face-edge-glow');
  if (eGlow) eGlow.style.boxShadow = 'inset 0 0 25px 15px rgba(' + Math.round(faceState.edgeR) + ',' + Math.round(faceState.edgeG) + ',' + Math.round(faceState.edgeB) + ',' + ep.toFixed(3) + ')';

  requestAnimationFrame(drawFace);
}

// ── Meet State Polling ───────────────────────────────────────────────────────

function pollMeetState() {
  if (currentPage !== 'meet') return;
  fetch('/health').then(function(r) { return r.json(); }).then(function(d) {
    var dot = document.getElementById('stat-dot-network');
    var label = document.getElementById('stat-network');
    if (d.inferenceOnline > 0) {
      dot.className = 'stat-dot';
      label.textContent = d.inferenceOnline + ' node' + (d.inferenceOnline !== 1 ? 's' : '') + ' online';
    } else {
      dot.className = 'stat-dot offline';
      label.textContent = 'No nodes online';
    }
  }).catch(function() {
    document.getElementById('stat-dot-network').className = 'stat-dot offline';
    document.getElementById('stat-network').textContent = 'Checking...';
  });
}

// ── Chat (Meet Page) ─────────────────────────────────────────────────────────

var chatHistory = [], isChatting = false;
var chatInput = document.getElementById('chat-input');
var chatMessages = document.getElementById('chat-messages');

chatInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
});

function sendChatMessage() {
  var msg = chatInput.value.trim();
  if (!msg || isChatting) return;
  if (msg.length > 500) { showError('Message must be under 500 characters'); return; }

  isChatting = true;
  document.getElementById('chat-send').disabled = true;
  chatInput.value = '';

  var ub = document.createElement('div'); ub.className = 'chat-bubble user'; ub.textContent = msg;
  chatMessages.appendChild(ub); scrollChat();

  faceState.talking = true; faceState.eyeOpen = 0.8; faceState.pupilSize = 0.9;

  var hApi = chatHistory.slice(-6).map(function(h) { return { role: h.role, text: h.text }; });

  fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: msg, history: hApi }),
  })
  .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
  .then(function(r) {
    faceState.talking = false;
    if (r.status !== 200) {
      var eb = document.createElement('div'); eb.className = 'chat-bubble system';
      eb.textContent = r.data.error || 'Something went wrong';
      chatMessages.appendChild(eb); scrollChat(); return;
    }
    chatHistory.push({ role: 'user', text: msg });
    chatHistory.push({ role: 'assistant', text: r.data.response });
    faceState.mouthCurve = 0.25; faceState.eyeOpen = 0.7;

    var bb = document.createElement('div'); bb.className = 'chat-bubble assistant';
    chatMessages.appendChild(bb);
    typeWriter(bb, r.data.response, 15);
    scrollChat();
  })
  .catch(function() {
    faceState.talking = false;
    var eb = document.createElement('div'); eb.className = 'chat-bubble system';
    eb.textContent = 'Could not reach Wattson. Try again.';
    chatMessages.appendChild(eb); scrollChat();
  })
  .finally(function() {
    isChatting = false;
    document.getElementById('chat-send').disabled = false;
    chatInput.focus();
  });
}

function scrollChat() {
  setTimeout(function() { chatMessages.scrollTop = chatMessages.scrollHeight; }, 50);
}

// ── Network / Connect Page ───────────────────────────────────────────────────

function loadNetwork() {
  fetch('/api/network').then(function(r) { return r.json(); }).then(function(d) {
    document.getElementById('net-devices').textContent = d.onlineCount || 0;
    document.getElementById('net-queries').textContent = d.totalQueries || 0;
    document.getElementById('net-version').textContent = d.networkVersion || '-';

    var nl = document.getElementById('node-list'); nl.innerHTML = '';
    var nodes = d.nodes || [];
    for (var i = 0; i < nodes.length; i++) {
      var n = nodes[i];
      var c = document.createElement('div'); c.className = 'node-card';
      c.innerHTML = '<div class="node-indicator' + (n.status !== 'online' ? ' offline' : '') + '"></div>' +
        '<div class="node-info"><div class="node-name">' + esc(n.name) + '</div>' +
        '<div class="node-meta">' + esc(n.type) + ' &middot; ' + esc(n.powerMode || 'FULL_FORCE') +
        (n.specs ? ' &middot; ' + esc(n.specs.ram || '') : '') + '</div></div>' +
        '<div class="node-model">' + esc(n.model || '-') + '</div>';
      nl.appendChild(c);
    }

    var on = d.onlineCount || 0, tot = d.deviceCount || 1;
    var pct = Math.round((on / tot) * 100);
    document.getElementById('health-fill').style.width = pct + '%';
    var hl = pct === 100 ? 'OPTIMAL' : pct >= 60 ? 'HEALTHY' : pct >= 40 ? 'DEGRADED' : 'CRITICAL';
    document.getElementById('health-label').textContent = on + '/' + tot + ' nodes online — ' + hl;
  }).catch(function() {
    document.getElementById('health-label').textContent = 'Could not reach network';
  });
}

// ── Dashboard ────────────────────────────────────────────────────────────

var dashTimer = null;

function loadDashboard() {
  if (dashTimer) clearInterval(dashTimer);
  fetchDashboard();
  loadContribDashboard();
  dashTimer = setInterval(function() {
    if (currentPage === 'dashboard') { fetchDashboard(); loadContribDashboard(); }
    else { clearInterval(dashTimer); dashTimer = null; }
  }, 10000);
}

function fetchDashboard() {
  fetch('/api/network').then(function(r) { return r.json(); }).then(function(d) {
    document.getElementById('dash-total-nodes').textContent = d.deviceCount || 0;
    document.getElementById('dash-inference-online').textContent = (d.inferenceOnline || 0) + '/' + (d.inferenceCount || 0);
    document.getElementById('dash-pending-jobs').textContent = (d.pendingJobs || 0) + (d.processingJobs ? '+' + d.processingJobs : '');
    document.getElementById('dash-total-queries').textContent = d.totalQueries || 0;
    document.getElementById('dash-version').textContent = d.networkVersion || '-';

    var tbody = document.getElementById('dash-table-body');
    tbody.innerHTML = '';
    var nodes = d.nodes || [];
    var maxQ = 1;
    for (var i = 0; i < nodes.length; i++) {
      if ((nodes[i].queriesServed || 0) > maxQ) maxQ = nodes[i].queriesServed;
    }
    for (var j = 0; j < nodes.length; j++) {
      var n = nodes[j];
      var tr = document.createElement('tr');
      var statusCls = n.status === 'online' ? 'online' : 'offline';
      var roleCls = n.role || 'inference';
      var qPct = maxQ > 0 ? Math.round(((n.queriesServed || 0) / maxQ) * 100) : 0;
      var lastSeen = n.lastSeen ? timeAgo(n.lastSeen) : 'Never';
      var avgMs = n.averageResponseMs ? n.averageResponseMs + 'ms' : '-';
      tr.innerHTML =
        '<td><span class="dash-status-dot ' + statusCls + '"></span></td>' +
        '<td><strong>' + esc(n.name) + '</strong><br><span style="font-size:12px;color:rgba(245,245,247,0.35)">' + esc(n.type || '') + '</span></td>' +
        '<td><span class="role-badge ' + roleCls + '">' + esc(roleCls) + '</span></td>' +
        '<td><div class="query-bar-wrap"><div class="query-bar" style="width:' + qPct + '%"></div></div>' + (n.queriesServed || 0) + '</td>' +
        '<td>' + avgMs + '</td>' +
        '<td style="font-size:12px;color:rgba(245,245,247,0.35)">' + lastSeen + '</td>';
      tbody.appendChild(tr);
    }
  }).catch(function() {
    document.getElementById('dash-refresh-label').textContent = 'Could not reach network';
  });
}

// ── Contributor Dashboard ──────────────────────────────────────────────────

function loadContribDashboard() {
  var container = document.getElementById('contrib-dashboard');
  if (!container) return;

  var token = localStorage.getItem('wattson_token');
  if (!token) {
    container.style.display = 'block';
    container.innerHTML =
      '<div class="contrib-signin">' +
        'Want to manage your nodes? <a href="/start" onclick="event.preventDefault();navigateTo(\'/start\')">Sign in</a> to see your contributor dashboard.' +
      '</div>';
    return;
  }

  fetch('/api/contributor/nodes', {
    headers: { 'Authorization': 'Bearer ' + token },
  })
  .then(function(r) {
    if (r.status === 401) {
      container.style.display = 'block';
      container.innerHTML =
        '<div class="contrib-signin">' +
          'Session expired. <a href="/start" onclick="event.preventDefault();navigateTo(\'/start\')">Sign in again</a> to manage your nodes.' +
        '</div>';
      return null;
    }
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    container.style.display = 'block';

    if (!data.nodes || data.nodes.length === 0) {
      container.innerHTML =
        '<h2>My Nodes</h2>' +
        '<div class="contrib-no-node">' +
          'You don\'t have any nodes yet. <a href="/start" onclick="event.preventDefault();navigateTo(\'/start\')">Set up your device</a> to start contributing.' +
        '</div>';
      return;
    }

    var html = '<h2>My Nodes</h2>';
    for (var i = 0; i < data.nodes.length; i++) {
      var n = data.nodes[i];
      var statusCls = n.status === 'online' ? 'online' : 'offline';
      var statusText = n.status === 'online' ? 'Online' : 'Offline';
      var avgMs = n.averageResponseMs ? n.averageResponseMs + 'ms' : '-';
      var lastSeen = n.lastSeen ? timeAgo(n.lastSeen) : 'Never';
      var pm = n.powerMode || 'FULL_FORCE';

      html +=
        '<div class="contrib-card" data-node-id="' + esc(n.id) + '">' +
          '<div class="contrib-card-header">' +
            '<span class="contrib-pulse-dot ' + statusCls + '"></span>' +
            '<div>' +
              '<div class="contrib-name">' + esc(n.name) + ' <span style="font-weight:400;color:rgba(245,245,247,0.4)">(' + statusText + ')</span></div>' +
              '<div class="contrib-type">' + esc(n.type || 'unknown') + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="contrib-stats">' +
            '<div class="contrib-stat"><div class="contrib-stat-value">' + (n.queriesServed || 0) + '</div><div class="contrib-stat-label">Queries</div></div>' +
            '<div class="contrib-stat"><div class="contrib-stat-value">' + avgMs + '</div><div class="contrib-stat-label">Avg Response</div></div>' +
            '<div class="contrib-stat"><div class="contrib-stat-value">' + esc(n.model || '-') + '</div><div class="contrib-stat-label">Model</div></div>' +
            '<div class="contrib-stat"><div class="contrib-stat-value">' + lastSeen + '</div><div class="contrib-stat-label">Last Seen</div></div>' +
          '</div>' +
          '<div class="contrib-power-selector">' +
            '<button class="contrib-power-btn' + (pm === 'FULL_FORCE' ? ' active' : '') + '" onclick="changeNodePower(\'' + esc(n.id) + '\',\'FULL_FORCE\',this)">Full Force</button>' +
            '<button class="contrib-power-btn' + (pm === 'HALF_FORCE' ? ' active' : '') + '" onclick="changeNodePower(\'' + esc(n.id) + '\',\'HALF_FORCE\',this)">Half Force</button>' +
            '<button class="contrib-power-btn' + (pm === 'ECO' ? ' active' : '') + '" onclick="changeNodePower(\'' + esc(n.id) + '\',\'ECO\',this)">Eco</button>' +
          '</div>' +
          '<button class="contrib-remove-btn" onclick="removeNode(\'' + esc(n.id) + '\')">Remove Node</button>' +
        '</div>';
    }
    container.innerHTML = html;
  })
  .catch(function() {
    container.style.display = 'block';
    container.innerHTML =
      '<div class="contrib-no-node">Could not load your nodes.</div>';
  });
}

function changeNodePower(nodeId, mode, btn) {
  var token = localStorage.getItem('wattson_token');
  if (!token) return;

  // Optimistic UI — highlight active button
  var parent = btn.parentElement;
  var btns = parent.querySelectorAll('.contrib-power-btn');
  for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
  btn.classList.add('active');

  fetch('/api/contributor/nodes/' + nodeId + '/config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ powerMode: mode }),
  })
  .then(function(r) {
    if (r.status !== 200) return r.json().then(function(d) { showError(d.error || 'Failed to update'); });
  })
  .catch(function() { showError('Network error'); });
}

function removeNode(nodeId) {
  if (!confirm('Remove this node from the network? The client will stop on its next poll.')) return;
  var token = localStorage.getItem('wattson_token');
  if (!token) return;

  fetch('/api/contributor/nodes/' + nodeId, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token },
  })
  .then(function(r) {
    if (r.status === 200) {
      loadContribDashboard();
    } else {
      return r.json().then(function(d) { showError(d.error || 'Failed to remove'); });
    }
  })
  .catch(function() { showError('Network error'); });
}

function timeAgo(iso) {
  var diff = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
  if (diff < 5) return 'just now';
  if (diff < 60) return diff + 's ago';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

// ── Utilities ────────────────────────────────────────────────────────────────

function esc(s) {
  if (typeof s !== 'string') return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function showError(msg) {
  var t = document.getElementById('error-toast');
  t.textContent = msg; t.classList.add('visible');
  setTimeout(function() { t.classList.remove('visible'); }, 4000);
}

function toggleSetup(header) {
  var item = header.parentElement;
  var body = item.querySelector('.setup-body');
  var isOpen = item.classList.contains('open');
  var all = document.querySelectorAll('.setup-item');
  for (var i = 0; i < all.length; i++) {
    all[i].classList.remove('open');
    all[i].querySelector('.setup-body').style.maxHeight = '0';
  }
  if (!isOpen) { item.classList.add('open'); body.style.maxHeight = body.scrollHeight + 'px'; }
}

var selectedDevice = null;

function selectDevice(device) {
  selectedDevice = device;
  // Hide device chooser, show wizard progress + Step 1
  var chooser = document.getElementById('device-chooser');
  var progress = document.getElementById('wizard-progress');
  if (chooser) chooser.style.display = 'none';
  if (progress) progress.style.display = 'flex';
  advanceWizard(1);
}

function loadWizardStep3() {
  var content = document.getElementById('wiz-setup-content');
  if (!content) return;
  content.innerHTML = '<div class="wiz-loading">Detecting your device...</div>';

  var setupUrl = '/api/setup';
  if (selectedDevice) setupUrl += '?device=' + encodeURIComponent(selectedDevice);

  fetch(setupUrl)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      content.innerHTML = '';

      // Monitor role (iPhone/iPad)
      if (data.role === 'monitor') {
        var badge = document.createElement('div');
        badge.className = 'monitor-badge';
        badge.textContent = 'iPhone / iPad \u2014 Monitor Node';
        content.appendChild(badge);

        var explain = document.createElement('p');
        explain.className = 'monitor-explain';
        explain.textContent = data.message || 'Your device becomes a network monitor node.';
        content.appendChild(explain);

        // Sub-step 1: Add to Home Screen
        var sub1 = document.createElement('div');
        sub1.className = 'monitor-substep';
        sub1.innerHTML = '<div class="monitor-substep-title"><span class="monitor-substep-num">1</span>Add to Home Screen</div>' +
          '<p>In Safari: tap Share \u2192 "Add to Home Screen". This installs Wattson as a PWA for a native app experience.</p>';
        content.appendChild(sub1);

        // Sub-step 2: Start Monitoring button
        var sub2 = document.createElement('div');
        sub2.className = 'monitor-substep';
        sub2.innerHTML = '<div class="monitor-substep-title"><span class="monitor-substep-num">2</span>Start Monitoring</div>' +
          '<p>Once installed, tap the button below to activate your monitor node.</p>';
        content.appendChild(sub2);

        var btn = document.createElement('button');
        btn.className = 'start-monitor-btn';
        btn.textContent = 'Start Monitoring';
        btn.onclick = startMonitoring;
        content.appendChild(btn);
        return;
      }

      if (!data.supported) {
        content.innerHTML = '<div class="wizard-unsupported">' +
          (data.message || 'This device is not supported yet. Check the detailed guides below.') + '</div>';
        return;
      }

      var osNames = { mac: 'Mac', windows: 'Windows', linux: 'Linux', android: 'Android', unknown: 'Your Device' };
      var badge = document.createElement('div');
      badge.className = 'wizard-detected';
      badge.textContent = 'Detected: ' + (osNames[data.os] || data.os);
      content.appendChild(badge);

      // Power mode selector
      var selector = document.createElement('div');
      selector.className = 'power-selector';
      selector.innerHTML =
        '<div class="power-selector-label">Choose your power mode:</div>' +
        '<div class="power-selector-options">' +
          '<div class="power-option selected" data-mode="FULL_FORCE" onclick="selectPowerMode(this)">' +
            '<div class="power-option-icon">&#9889;</div>' +
            '<div class="power-option-name">Full Force</div>' +
            '<div class="power-option-desc">100% dedicated</div>' +
          '</div>' +
          '<div class="power-option" data-mode="HALF_FORCE" onclick="selectPowerMode(this)">' +
            '<div class="power-option-icon">&#9881;</div>' +
            '<div class="power-option-name">Half Force</div>' +
            '<div class="power-option-desc">Share resources</div>' +
          '</div>' +
          '<div class="power-option" data-mode="ECO" onclick="selectPowerMode(this)">' +
            '<div class="power-option-icon">&#127807;</div>' +
            '<div class="power-option-name">Eco</div>' +
            '<div class="power-option-desc">Idle only</div>' +
          '</div>' +
        '</div>';
      content.appendChild(selector);

      // Commands container — re-rendered when power mode changes
      var cmdsContainer = document.createElement('div');
      cmdsContainer.id = 'wiz-commands-container';
      content.appendChild(cmdsContainer);

      // Store data for re-rendering on power mode change
      window._wizSetupData = data;
      renderSetupCommands(data, cmdsContainer);
    })
    .catch(function() {
      content.innerHTML = '<div style="text-align:center;color:rgba(245,245,247,0.4);padding:24px">' +
        'Could not detect your device. Check the detailed guides below.</div>';
    });
}

var selectedPowerMode = 'FULL_FORCE';

function selectPowerMode(el) {
  var opts = el.parentElement.querySelectorAll('.power-option');
  for (var i = 0; i < opts.length; i++) opts[i].classList.remove('selected');
  el.classList.add('selected');
  selectedPowerMode = el.getAttribute('data-mode');
  // Re-render commands with new power mode
  var container = document.getElementById('wiz-commands-container');
  if (container && window._wizSetupData) {
    renderSetupCommands(window._wizSetupData, container);
  }
}

function renderSetupCommands(data, container) {
  container.innerHTML = '';
  var token = contributorToken || 'YOUR_TOKEN';
  var pmEnv = 'POWER_MODE=' + selectedPowerMode;

  if (data.quickCommand) {
    var cmd = data.quickCommand.replace(/YOUR_TOKEN/g, token);
    var block = document.createElement('div');
    block.className = 'wizard-step';
    block.style.borderColor = 'rgba(10,132,255,0.2)';
    block.style.background = 'rgba(10,132,255,0.05)';
    var termLabel = data.os === 'android' ? 'Paste this into Termux' : 'Paste this into your terminal';
    block.innerHTML = '<div class="wizard-step-title" style="color:#0A84FF">' +
      termLabel + '</div>' +
      '<div class="wizard-command" style="font-size:15px"><button class="copy-btn" onclick="copyCommand(this)">Copy</button>' +
      escapeHtml(cmd) + '</div>' +
      '<div style="margin-top:12px;font-size:13px;color:rgba(245,245,247,0.4)">Auto-detects your device, installs Ollama, picks the best model, and downloads the client.</div>';
    container.appendChild(block);
  }

  if (data.steps && data.steps.length > 0) {
    if (data.quickCommand) {
      var divider = document.createElement('div');
      divider.style.cssText = 'text-align:center;margin:24px 0 16px;font-size:13px;color:rgba(245,245,247,0.25)';
      divider.textContent = 'Or follow the steps manually:';
      container.appendChild(divider);
    }
    for (var i = 0; i < data.steps.length; i++) {
      var step = data.steps[i];
      var stepCmd = step.command.replace(/YOUR_TOKEN/g, token);
      // Inject POWER_MODE into the "Start contributing" step
      if (step.title.toLowerCase().indexOf('start') !== -1 || step.title.toLowerCase().indexOf('contributing') !== -1) {
        stepCmd = stepCmd.replace(/(NODE_SECRET=)/,pmEnv + ' \\\n$1');
      }
      var div = document.createElement('div');
      div.className = 'wizard-step';
      div.innerHTML = '<div class="wizard-step-title"><span class="wizard-step-num">' + (i + 1) + '</span>' +
        step.title + '</div>' +
        '<div class="wizard-command"><button class="copy-btn" onclick="copyCommand(this)">Copy</button>' +
        escapeHtml(stepCmd) + '</div>';
      container.appendChild(div);
    }
  }
}

// ── Monitor Client ────────────────────────────────────────────────────────

var monitorHeartbeatInterval = null;

function startMonitoring() {
  var token = contributorToken;
  if (!token) { showError('Please sign in first to get a token'); return; }

  fetch('/api/nodes/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-Node-Secret': token },
    body: JSON.stringify({ name: 'iPhone Monitor', role: 'monitor', type: 'iphone' }),
  })
  .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
  .then(function(r) {
    if (r.status !== 201) {
      showError(r.data.error || 'Could not register monitor node');
      return;
    }
    var nodeId = r.data.node.id;
    localStorage.setItem('wattson_node_id', nodeId);
    localStorage.setItem('wattson_monitor_active', 'true');
    startHeartbeat(token, nodeId);
    showMonitorStatus(nodeId);
  })
  .catch(function() { showError('Network error. Please try again.'); });
}

function startHeartbeat(token, nodeId) {
  if (monitorHeartbeatInterval) clearInterval(monitorHeartbeatInterval);

  function doPoll() {
    fetch('/api/nodes/poll', {
      headers: { 'X-Node-Secret': token, 'X-Node-Id': nodeId },
    })
    .then(function(r) {
      if (r.status === 401) {
        // Stale node ID — auto-stop and prompt re-registration
        stopMonitoring();
        showError('Monitor session expired. Please start monitoring again.');
      }
    })
    .catch(function() { /* Network error — keep trying */ });
  }

  doPoll(); // Immediate first heartbeat
  monitorHeartbeatInterval = setInterval(doPoll, 30000);
}

function showMonitorStatus(nodeId) {
  var content = document.getElementById('wiz-setup-content');
  if (!content) return;
  content.innerHTML =
    '<div class="monitor-status-card">' +
      '<div class="monitor-pulse"><span class="monitor-pulse-dot"></span> Monitoring Active</div>' +
      '<div class="monitor-node-id">Node: ' + esc(nodeId) + '</div>' +
      '<button class="monitor-stop-btn" onclick="stopMonitoring()">Stop Monitoring</button>' +
    '</div>';
}

function stopMonitoring() {
  if (monitorHeartbeatInterval) {
    clearInterval(monitorHeartbeatInterval);
    monitorHeartbeatInterval = null;
  }
  localStorage.removeItem('wattson_node_id');
  localStorage.removeItem('wattson_monitor_active');
  // Reload Step 3
  loadWizardStep3();
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function copyCommand(btn) {
  var code = btn.parentElement.textContent.replace('Copy', '').replace('Copied!', '').trim();
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(function() {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(function() { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    });
  }
}

// ── Google Sign-In & Token Management ─────────────────────────────────────

var contributorToken = localStorage.getItem('wattson_token') || null;
var contributorName = localStorage.getItem('wattson_name') || null;

function handleGoogleSignIn(response) {
  fetch('/api/auth/google', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ credential: response.credential }),
  })
  .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
  .then(function(r) {
    if (r.status !== 200) {
      showError(r.data.error || 'Sign-in failed');
      return;
    }
    contributorToken = r.data.token;
    contributorName = r.data.name;
    localStorage.setItem('wattson_token', r.data.token);
    localStorage.setItem('wattson_name', r.data.name);
    localStorage.setItem('wattson_email', r.data.email);
    showTokenCard(r.data.token, r.data.name, r.data.email);
    advanceWizard(2);
  })
  .catch(function() {
    showError('Could not complete sign-in. Try again.');
  });
}

function showTokenCard(token, name, email) {
  var cardEl = document.getElementById('wiz-token-card');
  if (!cardEl) return;

  cardEl.innerHTML =
    '<div class="token-card">' +
      '<div class="token-card-header">' +
        '<div class="token-card-avatar" style="background:rgba(48,209,88,0.2);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#30D158">' +
          esc((name || '?').charAt(0).toUpperCase()) +
        '</div>' +
        '<div>' +
          '<div class="token-card-name">Welcome' + (name ? ', ' + esc(name) : '') + '!</div>' +
          (email ? '<div class="token-card-email">' + esc(email) + '</div>' : '') +
        '</div>' +
      '</div>' +
      '<div class="token-card-label">Your Contributor Token</div>' +
      '<div class="token-card-value" id="token-display">' +
        '<button class="copy-btn" onclick="copyToken()">Copy</button>' +
        esc(token) +
      '</div>' +
      '<div class="token-card-hint">Use this as your <code>NODE_SECRET</code> when running the client. It\'s saved in your browser for next time.</div>' +
      '<div class="token-card-actions">' +
        '<button class="token-revoke-btn" onclick="revokeToken()">Revoke Token</button>' +
      '</div>' +
    '</div>';
}

function copyToken() {
  if (!contributorToken || !navigator.clipboard) return;
  navigator.clipboard.writeText(contributorToken).then(function() {
    var btn = document.querySelector('#token-display .copy-btn');
    if (btn) {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(function() { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    }
  });
}

function revokeToken() {
  if (!contributorToken) return;
  fetch('/api/auth/revoke', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + contributorToken },
  })
  .then(function() {
    contributorToken = null;
    contributorName = null;
    localStorage.removeItem('wattson_token');
    localStorage.removeItem('wattson_name');
    localStorage.removeItem('wattson_email');
    var cardEl = document.getElementById('wiz-token-card');
    if (cardEl) cardEl.innerHTML = '';
    advanceWizard(1);
  })
  .catch(function() { showError('Could not revoke token. Try again.'); });
}

var wizardStep = 1;

function advanceWizard(step) {
  wizardStep = step;
  for (var i = 1; i <= 3; i++) {
    var stepEl = document.getElementById('wp-' + i);
    var lineEl = document.getElementById('wpl-' + (i - 1));
    if (stepEl) {
      stepEl.classList.remove('active', 'completed');
      if (i < step) stepEl.classList.add('completed');
      else if (i === step) stepEl.classList.add('active');
    }
    if (lineEl) lineEl.classList.toggle('active', i <= step);
  }
  for (var j = 1; j <= 3; j++) {
    var panel = document.getElementById('wiz-step-' + j);
    if (panel) panel.classList.toggle('active', j === step);
  }
  if (step === 3) loadWizardStep3();
}

function toggleManualToken() {
  var el = document.getElementById('wiz-alt-input');
  if (el) el.style.display = el.style.display === 'none' ? 'flex' : 'none';
}

function pasteToken() {
  var input = document.getElementById('manual-token-input');
  var token = input ? input.value.trim() : '';
  if (!token) { showError('Please paste a valid token'); return; }
  contributorToken = token;
  localStorage.setItem('wattson_token', token);
  showTokenCard(token, null, null);
  advanceWizard(2);
}

function useAnotherAccount() {
  contributorToken = null;
  contributorName = null;
  localStorage.removeItem('wattson_token');
  localStorage.removeItem('wattson_name');
  localStorage.removeItem('wattson_email');
  var cardEl = document.getElementById('wiz-token-card');
  if (cardEl) cardEl.innerHTML = '';
  advanceWizard(1);
}

function checkExistingToken() {
  var token = localStorage.getItem('wattson_token');
  if (!token) return;

  fetch('/api/auth/me', {
    headers: { 'Authorization': 'Bearer ' + token },
  })
  .then(function(r) {
    if (r.status !== 200) throw new Error('Invalid');
    return r.json();
  })
  .then(function(data) {
    contributorToken = token;
    contributorName = data.name;
    showTokenCard(token, data.name, data.email);
    advanceWizard(2);
  })
  .catch(function() {
    // Token invalid, clear it
    localStorage.removeItem('wattson_token');
    localStorage.removeItem('wattson_name');
    localStorage.removeItem('wattson_email');
    contributorToken = null;
    contributorName = null;
  });
}

// Check for returning visitors
checkExistingToken();

// Auto-resume monitor on return visit
(function() {
  var monActive = localStorage.getItem('wattson_monitor_active');
  var monNodeId = localStorage.getItem('wattson_node_id');
  var monToken = localStorage.getItem('wattson_token');
  if (monActive && monNodeId && monToken) {
    selectedDevice = 'iphone';
    // When navigating to /start, auto-advance to Step 3 and show status
    var origNav = window.navigateTo;
    function resumeMonitor() {
      var chooser = document.getElementById('device-chooser');
      var progress = document.getElementById('wizard-progress');
      if (chooser) chooser.style.display = 'none';
      if (progress) progress.style.display = 'flex';
      wizardStep = 3;
      advanceWizard(3);
      // After loadWizardStep3 renders, replace with monitor status
      setTimeout(function() {
        startHeartbeat(monToken, monNodeId);
        showMonitorStatus(monNodeId);
      }, 100);
    }
    // If already on /start, resume immediately after DOM settles
    if (window.location.pathname === '/start') {
      setTimeout(resumeMonitor, 300);
    }
    // Hook into navigateTo for future navigation to /start
    var _origNavigateTo = window.navigateTo;
    if (_origNavigateTo) {
      window.navigateTo = function(path) {
        _origNavigateTo(path);
        if (path === '/start') setTimeout(resumeMonitor, 300);
      };
    }
  }
})();

// Inject Google Client ID from server config
(function() {
  fetch('/api/auth/config').then(function(r) { return r.json(); }).then(function(d) {
    if (d.clientId) {
      var el = document.getElementById('g_id_onload');
      if (el) el.setAttribute('data-client_id', d.clientId);
    }
  }).catch(function() {});
})();
</script>
</body>
</html>
